services:
  garuda:
    build: .
    container_name: garuda-webapp
    network_mode: host
    restart: unless-stopped
    environment:
      - GARUDA_UI_API_KEY=${GARUDA_UI_API_KEY:-changeme}
      - GARUDA_DB_URL=${GARUDA_DB_URL:-sqlite:////app/data/crawler.db}
      - GARUDA_QDRANT_URL=${GARUDA_QDRANT_URL:-http://garuda-qdrant:6333}
      - GARUDA_QDRANT_COLLECTION=${GARUDA_QDRANT_COLLECTION:-pages}
      - GARUDA_OLLAMA_URL=${GARUDA_OLLAMA_URL:-http://garuda-ollama:11434/api/generate}
      - GARUDA_OLLAMA_MODEL=${GARUDA_OLLAMA_MODEL:-granite3.1-dense:8b}
      - GARUDA_UI_CORS_ORIGINS=*
    ports:
      - "8080:8080"
    volumes:
      - ./data/garuda/:/app/data/:rw
      - ./data/watch/:/app/watch/:ro
    depends_on:
      - qdrant
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]  # Remove this block if no GPU

  qdrant:
    image: qdrant/qdrant:latest
    container_name: garuda-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
    volumes:
      - ./data/qdrant/:/qdrant/storage

  ollama:
    image: ollama/ollama:latest
    container_name: garuda-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    profiles:
      - "llm"
    volumes:
      - ./data/ollama-llm:/root/.ollama:rw
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]  # Remove this block if no GPU

  ollama-exoscale:
    build: ./ollama-exoscale
    container_name: garuda-ollama-exoscale
    restart: unless-stopped
    ports:
      - "11434:11434"
    profiles:
      - "exoscale"
    environment:
      - EXOSCALE_API_KEY=${EXOSCALE_API_KEY:-}
      - EXOSCALE_API_SECRET=${EXOSCALE_API_SECRET:-}
      - EXOSCALE_ZONE=${EXOSCALE_ZONE:-at-vie-2}
      - EXOSCALE_INSTANCE_TYPE=${EXOSCALE_INSTANCE_TYPE:-a5000.small}
      - EXOSCALE_TEMPLATE=${EXOSCALE_TEMPLATE:-Linux Ubuntu 24.04 LTS 64-bit}
      - EXOSCALE_DISK_SIZE=${EXOSCALE_DISK_SIZE:-50}
      - EXOSCALE_IDLE_TIMEOUT=${EXOSCALE_IDLE_TIMEOUT:-1800}
      - OLLAMA_MODEL=${GARUDA_OLLAMA_MODEL:-granite3.1-dense:8b}

