<div class="space-y-6">
  <!-- Local Data Overview -->
  <div class="card p-6 bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border-2 border-amber-200 dark:border-amber-800">
    <h2 class="text-xl font-bold mb-2 text-amber-900 dark:text-amber-100">üìÅ Local Data Ingestion</h2>
    <p class="text-sm text-amber-700 dark:text-amber-300 mb-4">
      Upload files or watch directories to run the extraction pipeline on local data. Supports PDF, text, images, and media files.
    </p>

    <div class="grid grid-cols-4 gap-4 mt-4">
      <div class="text-center p-3 bg-white/60 dark:bg-slate-900/40 rounded-lg border border-amber-200 dark:border-amber-800">
        <div class="text-2xl mb-1">üìÑ</div>
        <div class="text-xs font-semibold text-amber-900 dark:text-amber-100">PDF</div>
      </div>
      <div class="text-center p-3 bg-white/60 dark:bg-slate-900/40 rounded-lg border border-amber-200 dark:border-amber-800">
        <div class="text-2xl mb-1">üìù</div>
        <div class="text-xs font-semibold text-amber-900 dark:text-amber-100">Text / Markdown</div>
      </div>
      <div class="text-center p-3 bg-white/60 dark:bg-slate-900/40 rounded-lg border border-amber-200 dark:border-amber-800">
        <div class="text-2xl mb-1">üñºÔ∏è</div>
        <div class="text-xs font-semibold text-amber-900 dark:text-amber-100">Images (OCR)</div>
      </div>
      <div class="text-center p-3 bg-white/60 dark:bg-slate-900/40 rounded-lg border border-amber-200 dark:border-amber-800">
        <div class="text-2xl mb-1">üéµ</div>
        <div class="text-xs font-semibold text-amber-900 dark:text-amber-100">Audio / Video</div>
      </div>
    </div>
  </div>

  <!-- File Upload -->
  <div class="card p-6">
    <h2 class="text-xl font-bold mb-4">üì§ Upload Files</h2>
    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
      Upload files to process through the intelligence extraction pipeline. Files are queued as tasks and processed asynchronously.
    </p>

    <form id="local-data-upload-form" class="space-y-4">
      <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-8 text-center hover:border-brand-400 dark:hover:border-brand-500 transition cursor-pointer" id="drop-zone">
        <div class="text-4xl mb-3">üìÇ</div>
        <p class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Drag & drop files here, or click to browse</p>
        <p class="text-xs text-slate-500 dark:text-slate-400">PDF, TXT, MD, CSV, JSON, XML, HTML, YAML, PNG, JPG, MP4, MP3, WAV and more</p>
        <input type="file" id="local-data-file-input" class="hidden" multiple
               accept=".pdf,.txt,.md,.csv,.json,.xml,.html,.htm,.yaml,.yml,.log,.rst,.ini,.cfg,.toml,.png,.jpg,.jpeg,.gif,.bmp,.tiff,.webp,.mp4,.avi,.mkv,.mov,.webm,.mp3,.wav,.ogg,.flac,.aac,.wma,.docx">
      </div>

      <div id="file-preview-list" class="space-y-2 hidden"></div>

      <button type="submit" id="upload-btn" class="w-full inline-flex items-center justify-center rounded-lg bg-brand-600 text-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
        </svg>
        Upload & Process
      </button>
    </form>

    <div id="upload-results" class="mt-4 space-y-2"></div>
  </div>

  <!-- Ingest from Local Path -->
  <div class="card p-6">
    <h2 class="text-xl font-bold mb-4">üì• Ingest from Local Path</h2>
    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
      Process a file directly from a path on the server filesystem.
    </p>

    <form id="local-data-ingest-form" class="flex gap-2">
      <input type="text" id="ingest-file-path"
             class="flex-1 px-3 py-2 border rounded-lg text-sm bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700"
             placeholder="/path/to/file.pdf" required>
      <button type="submit" class="btn-primary px-4 py-2 rounded-lg bg-brand-600 text-white text-sm font-medium hover:bg-brand-500">
        Ingest
      </button>
    </form>

    <div id="ingest-result" class="mt-3"></div>
  </div>

  <!-- Directory Watcher -->
  <div class="card p-6">
    <h2 class="text-xl font-bold mb-4">üëÅÔ∏è Directory Watcher</h2>
    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
      Automatically monitors a directory for new or modified files and queues them for processing.
      Configure via <code class="text-xs bg-slate-100 dark:bg-slate-800 px-1 rounded">GARUDA_LOCAL_DATA_WATCH_DIR</code> and
      <code class="text-xs bg-slate-100 dark:bg-slate-800 px-1 rounded">GARUDA_LOCAL_DATA_WATCH_ENABLED=true</code>.
    </p>

    <div id="watcher-status-container" class="space-y-4">
      <div class="flex gap-2 mb-4">
        <button onclick="window.loadWatcherStatus()" class="btn-secondary px-3 py-1.5 rounded-lg border text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-800">
          Refresh Status
        </button>
        <button onclick="window.triggerManualScan()" id="scan-btn" class="px-3 py-1.5 rounded-lg bg-amber-600 text-white text-sm font-medium hover:bg-amber-500 disabled:opacity-50" disabled>
          üîç Manual Scan
        </button>
      </div>

      <div id="watcher-status" class="p-4 border rounded-lg bg-slate-50 dark:bg-slate-900/40">
        <p class="text-sm text-slate-500 italic">Click "Refresh Status" to check directory watcher...</p>
      </div>
    </div>
  </div>

  <!-- Supported File Types -->
  <div class="card p-6">
    <h2 class="text-xl font-bold mb-4">üìã Supported File Types</h2>
    <div id="supported-types-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <p class="text-sm text-slate-500 italic col-span-full">Loading supported types...</p>
    </div>
  </div>

  <!-- Recent Local Ingestion Tasks -->
  <div class="card p-6">
    <h2 class="text-xl font-bold mb-4">üìä Recent Ingestion Tasks</h2>
    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
      Track the progress of queued file ingestion tasks.
    </p>

    <div class="flex gap-2 mb-4">
      <button onclick="window.loadLocalTasks()" class="btn-primary px-3 py-1.5 rounded-lg bg-brand-600 text-white text-sm font-medium hover:bg-brand-500">
        Refresh Tasks
      </button>
    </div>

    <div id="local-tasks-container" class="space-y-2">
      <p class="text-sm text-slate-500 italic">Click "Refresh Tasks" to load ingestion tasks...</p>
    </div>
  </div>

  <!-- File Browser -->
  <div class="card p-6">
    <h2 class="text-xl font-bold mb-4">üìÇ Browse Files</h2>
    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
      Browse uploaded and processed files. View content, edit metadata, and manage relationships.
    </p>

    <div class="flex gap-2 mb-4 flex-wrap">
      <input type="text" id="file-search-input"
             class="flex-1 min-w-[200px] px-3 py-2 border rounded-lg text-sm bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700"
             placeholder="Search files by name or content...">
      <button onclick="window.loadFiles()" class="btn-primary px-3 py-1.5 rounded-lg bg-brand-600 text-white text-sm font-medium hover:bg-brand-500">
        üîç Search
      </button>
      <button onclick="window.loadFiles()" class="btn-secondary px-3 py-1.5 rounded-lg border text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-800">
        Refresh
      </button>
    </div>

    <div id="file-browser-container" class="space-y-2">
      <p class="text-sm text-slate-500 italic">Loading files...</p>
    </div>

    <div id="file-browser-pagination" class="flex justify-between items-center mt-4 hidden">
      <span id="file-browser-info" class="text-xs text-slate-500"></span>
      <div class="flex gap-2">
        <button onclick="window.loadFilesPrev()" id="files-prev-btn" class="px-3 py-1 rounded border text-sm disabled:opacity-50" disabled>‚Üê Prev</button>
        <button onclick="window.loadFilesNext()" id="files-next-btn" class="px-3 py-1 rounded border text-sm disabled:opacity-50" disabled>Next ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- File Detail Modal -->
  <div id="file-detail-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white dark:bg-slate-900 border-b p-4 flex justify-between items-center">
        <h3 id="file-detail-title" class="text-lg font-bold truncate"></h3>
        <button onclick="window.closeFileDetail()" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
      </div>
      <div id="file-detail-content" class="p-6 space-y-4"></div>
    </div>
  </div>
</div>

<script type="module">
import { fetchWithAPIKey } from '/static/api.js';

async function fetchJSON(url, options = {}) {
  const response = await fetchWithAPIKey(url, options);
  return response.json();
}

// ============================================================================
// File Upload
// ============================================================================

const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('local-data-file-input');
const filePreviewList = document.getElementById('file-preview-list');
const uploadBtn = document.getElementById('upload-btn');
let selectedFiles = [];

dropZone?.addEventListener('click', () => fileInput?.click());

dropZone?.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('border-brand-400', 'bg-brand-50', 'dark:bg-brand-900/10');
});

dropZone?.addEventListener('dragleave', () => {
  dropZone.classList.remove('border-brand-400', 'bg-brand-50', 'dark:bg-brand-900/10');
});

dropZone?.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('border-brand-400', 'bg-brand-50', 'dark:bg-brand-900/10');
  if (e.dataTransfer.files.length > 0) {
    selectedFiles = Array.from(e.dataTransfer.files);
    renderFilePreview();
  }
});

fileInput?.addEventListener('change', () => {
  if (fileInput.files.length > 0) {
    selectedFiles = Array.from(fileInput.files);
    renderFilePreview();
  }
});

function renderFilePreview() {
  if (selectedFiles.length === 0) {
    filePreviewList.classList.add('hidden');
    uploadBtn.disabled = true;
    return;
  }

  filePreviewList.classList.remove('hidden');
  uploadBtn.disabled = false;

  filePreviewList.innerHTML = selectedFiles.map((f, i) => `
    <div class="flex items-center justify-between p-2 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-700">
      <div class="flex items-center gap-2 min-w-0">
        <span class="text-sm">${getFileIcon(f.name)}</span>
        <span class="text-sm font-medium truncate">${f.name}</span>
        <span class="text-xs text-slate-500">(${formatFileSize(f.size)})</span>
      </div>
      <button type="button" onclick="window.removeFile(${i})" class="text-slate-400 hover:text-red-500 text-sm">&times;</button>
    </div>
  `).join('');
}

window.removeFile = function(index) {
  selectedFiles.splice(index, 1);
  renderFilePreview();
};

function getFileIcon(name) {
  const ext = name.split('.').pop()?.toLowerCase() || '';
  if (['pdf'].includes(ext)) return 'üìÑ';
  if (['txt', 'md', 'rst', 'log'].includes(ext)) return 'üìù';
  if (['csv', 'json', 'xml', 'yaml', 'yml', 'toml'].includes(ext)) return 'üìä';
  if (['html', 'htm'].includes(ext)) return 'üåê';
  if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'tiff', 'webp'].includes(ext)) return 'üñºÔ∏è';
  if (['mp4', 'avi', 'mkv', 'mov', 'webm'].includes(ext)) return 'üé•';
  if (['mp3', 'wav', 'ogg', 'flac', 'aac', 'wma'].includes(ext)) return 'üéµ';
  return 'üìé';
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

document.getElementById('local-data-upload-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (selectedFiles.length === 0) return;

  const resultsDiv = document.getElementById('upload-results');
  resultsDiv.innerHTML = '';
  uploadBtn.disabled = true;
  uploadBtn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Uploading...';

  const results = [];
  for (const file of selectedFiles) {
    try {
      const formData = new FormData();
      formData.append('file', file);
      const data = await fetchJSON('/api/local-data/upload', {
        method: 'POST',
        body: formData,
      });
      results.push({ file: file.name, success: true, data });
    } catch (error) {
      results.push({ file: file.name, success: false, error: error.message });
    }
  }

  resultsDiv.innerHTML = results.map(r => r.success
    ? `<div class="p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-sm">
         <span class="font-semibold text-green-800 dark:text-green-200">‚úì ${r.file}</span>
         <span class="text-green-600 dark:text-green-400 ml-2">Task: ${r.data.task_id}</span>
       </div>`
    : `<div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-sm">
         <span class="font-semibold text-red-800 dark:text-red-200">‚úó ${r.file}</span>
         <span class="text-red-600 dark:text-red-400 ml-2">${r.error}</span>
       </div>`
  ).join('');

  selectedFiles = [];
  filePreviewList.classList.add('hidden');
  fileInput.value = '';
  uploadBtn.disabled = true;
  uploadBtn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>Upload & Process';

  // Auto-refresh tasks
  setTimeout(() => loadLocalTasks(), 500);
});

// ============================================================================
// Ingest from Path
// ============================================================================

document.getElementById('local-data-ingest-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const filePath = document.getElementById('ingest-file-path').value.trim();
  const resultDiv = document.getElementById('ingest-result');

  if (!filePath) return;

  resultDiv.innerHTML = '<p class="text-sm text-slate-500">Processing...</p>';

  try {
    const data = await fetchJSON('/api/local-data/ingest', {
      method: 'POST',
      body: JSON.stringify({ file_path: filePath }),
    });

    resultDiv.innerHTML = `<div class="p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-sm">
      <span class="font-semibold text-green-800 dark:text-green-200">‚úì File queued for processing</span>
      <span class="text-green-600 dark:text-green-400 ml-2">Task: ${data.task_id}</span>
    </div>`;

    document.getElementById('ingest-file-path').value = '';
    setTimeout(() => loadLocalTasks(), 500);
  } catch (error) {
    resultDiv.innerHTML = `<div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-sm">
      <span class="font-semibold text-red-800 dark:text-red-200">‚úó Error</span>
      <span class="text-red-600 dark:text-red-400 ml-2">${error.message}</span>
    </div>`;
  }
});

// ============================================================================
// Directory Watcher
// ============================================================================

async function loadWatcherStatus() {
  const container = document.getElementById('watcher-status');
  const scanBtn = document.getElementById('scan-btn');

  try {
    const status = await fetchJSON('/api/local-data/watcher/status');

    if (status.enabled === false) {
      container.innerHTML = `
        <div class="flex items-center gap-3 text-amber-700 dark:text-amber-300">
          <span class="text-xl">‚ö†Ô∏è</span>
          <div>
            <div class="font-semibold">Directory Watcher Not Configured</div>
            <div class="text-xs mt-1">${status.message || 'Set GARUDA_LOCAL_DATA_WATCH_DIR and GARUDA_LOCAL_DATA_WATCH_ENABLED=true to enable.'}</div>
          </div>
        </div>`;
      scanBtn.disabled = true;
      return;
    }

    scanBtn.disabled = false;

    const running = status.running;
    container.innerHTML = `
      <div class="space-y-3">
        <div class="flex items-center gap-2">
          <span class="h-3 w-3 rounded-full ${running ? 'bg-green-500 animate-pulse' : 'bg-slate-400'}"></span>
          <span class="font-semibold text-sm">${running ? 'Watching' : 'Stopped'}</span>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div class="p-2 bg-white dark:bg-slate-800 rounded border">
            <div class="text-xs text-slate-500">Watch Directory</div>
            <div class="font-mono text-xs truncate" title="${status.watch_dir || 'N/A'}">${status.watch_dir || 'N/A'}</div>
          </div>
          <div class="p-2 bg-white dark:bg-slate-800 rounded border">
            <div class="text-xs text-slate-500">Tracked Files</div>
            <div class="font-bold text-brand-600">${status.tracked_files ?? 0}</div>
          </div>
          <div class="p-2 bg-white dark:bg-slate-800 rounded border">
            <div class="text-xs text-slate-500">Poll Interval</div>
            <div class="font-mono text-xs">${status.poll_interval ?? '-'}s</div>
          </div>
          <div class="p-2 bg-white dark:bg-slate-800 rounded border">
            <div class="text-xs text-slate-500">Last Scan</div>
            <div class="font-mono text-xs">${status.last_scan_time ? new Date(status.last_scan_time).toLocaleString() : 'Never'}</div>
          </div>
        </div>
      </div>`;
  } catch (error) {
    container.innerHTML = `<p class="text-sm text-red-500">Error: ${error.message}</p>`;
  }
}

async function triggerManualScan() {
  const scanBtn = document.getElementById('scan-btn');
  const statusContainer = document.getElementById('watcher-status');
  scanBtn.disabled = true;
  scanBtn.textContent = '‚è≥ Scanning...';

  try {
    const result = await fetchJSON('/api/local-data/watcher/scan', { method: 'POST' });

    const msg = `Scan complete: ${result.queued} files queued, ${result.skipped} skipped`;
    statusContainer.insertAdjacentHTML('afterbegin',
      `<div class="p-3 mb-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-sm text-green-800 dark:text-green-200">‚úì ${msg}</div>`);
    loadWatcherStatus();
    setTimeout(() => loadLocalTasks(), 500);
  } catch (error) {
    statusContainer.insertAdjacentHTML('afterbegin',
      `<div class="p-3 mb-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-sm text-red-800 dark:text-red-200">‚úó Scan error: ${error.message}</div>`);
  } finally {
    scanBtn.disabled = false;
    scanBtn.textContent = 'üîç Manual Scan';
  }
}

// ============================================================================
// Supported Types
// ============================================================================

async function loadSupportedTypes() {
  const container = document.getElementById('supported-types-container');

  try {
    const data = await fetchJSON('/api/local-data/supported-types');
    const categories = data.categories || {};

    const icons = { pdf: 'üìÑ', text: 'üìù', image: 'üñºÔ∏è', media: 'üéµ' };
    const labels = { pdf: 'PDF Documents', text: 'Text Files', image: 'Images', media: 'Audio / Video' };

    container.innerHTML = Object.entries(categories).map(([cat, exts]) => `
      <div class="p-3 border rounded-lg">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-lg">${icons[cat] || 'üìé'}</span>
          <span class="font-semibold text-sm">${labels[cat] || cat}</span>
        </div>
        <div class="flex flex-wrap gap-1">
          ${(exts || []).map(ext => `<span class="text-xs px-1.5 py-0.5 bg-slate-100 dark:bg-slate-800 rounded font-mono">${ext}</span>`).join('')}
        </div>
      </div>
    `).join('');
  } catch (error) {
    container.innerHTML = `<p class="text-sm text-red-500 col-span-full">Error loading types: ${error.message}</p>`;
  }
}

// ============================================================================
// Recent Tasks
// ============================================================================

async function loadLocalTasks() {
  const container = document.getElementById('local-tasks-container');

  try {
    const data = await fetchJSON('/api/tasks/?type=local_ingest&limit=20');
    const tasks = data.tasks || [];

    if (tasks.length === 0) {
      container.innerHTML = '<p class="text-sm text-slate-500 italic">No ingestion tasks found. Upload a file or ingest from path to get started.</p>';
      return;
    }

    container.innerHTML = tasks.map(t => {
      const statusColor = {
        'completed': 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
        'running': 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
        'pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300',
        'failed': 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
        'cancelled': 'bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-300',
      }[t.status] || 'bg-slate-100 text-slate-800';

      const params = t.params || {};
      const result = t.result || {};
      const filename = params.original_filename || params.file_path?.split('/').pop() || 'Unknown';

      return `
        <div class="p-3 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
          <div class="flex items-start justify-between gap-2">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1 flex-wrap">
                <span class="text-sm font-medium truncate">${filename}</span>
                <span class="text-xs px-2 py-0.5 rounded-full ${statusColor}">${t.status}</span>
                ${params.event ? `<span class="text-xs px-1.5 py-0.5 bg-slate-100 dark:bg-slate-800 rounded">${params.event}</span>` : ''}
              </div>
              ${t.status === 'running' && t.progress !== undefined ? `
                <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-1.5 mt-2">
                  <div class="bg-brand-600 h-1.5 rounded-full transition-all" style="width: ${(t.progress * 100).toFixed(0)}%"></div>
                </div>
                <div class="text-xs text-slate-500 mt-1">${t.progress_message || ''} (${(t.progress * 100).toFixed(0)}%)</div>
              ` : ''}
              ${t.status === 'completed' && result.content_length ? `
                <div class="text-xs text-slate-500 mt-1">
                  Extracted ${result.content_length.toLocaleString()} chars | Confidence: ${(result.confidence * 100).toFixed(0)}%
                  ${result.entities_extracted ? ` | Entities: ${result.entities_extracted}` : ''}
                  ${result.intel_extracted ? ` | Intel: ${result.intel_extracted}` : ''}
                  ${result.relationships_created ? ` | Relations: ${result.relationships_created}` : ''}
                </div>
              ` : ''}
              ${t.status === 'failed' && t.error ? `
                <div class="text-xs text-red-600 dark:text-red-400 mt-1">${t.error}</div>
              ` : ''}
            </div>
            <div class="text-xs text-slate-400 whitespace-nowrap">${t.created_at ? new Date(t.created_at).toLocaleString() : ''}</div>
          </div>
        </div>`;
    }).join('');
  } catch (error) {
    container.innerHTML = `<p class="text-sm text-red-500">Error loading tasks: ${error.message}</p>`;
  }
}

// Expose to global scope
window.loadWatcherStatus = loadWatcherStatus;
window.triggerManualScan = triggerManualScan;
window.loadLocalTasks = loadLocalTasks;

// ============================================================================
// File Browser
// ============================================================================

let filesOffset = 0;
const filesLimit = 20;
let filesTotalCount = 0;

async function loadFiles(resetOffset = true) {
  if (resetOffset) filesOffset = 0;
  const container = document.getElementById('file-browser-container');
  const q = document.getElementById('file-search-input')?.value || '';

  container.innerHTML = '<p class="text-sm text-slate-500 italic">Loading files...</p>';

  try {
    const params = new URLSearchParams({
      limit: filesLimit,
      offset: filesOffset,
    });
    if (q) params.append('q', q);

    const data = await fetchJSON(`/api/local-data/files?${params}`);
    const files = data.files || [];
    filesTotalCount = data.total || 0;

    if (files.length === 0) {
      container.innerHTML = '<p class="text-sm text-slate-500 italic">No files found. Upload files above to get started.</p>';
      document.getElementById('file-browser-pagination').classList.add('hidden');
      return;
    }

    container.innerHTML = files.map(f => {
      const ext = (f.file_type || f.url?.split('.').pop() || '').replace('.', '');
      const icon = getFileIcon(f.original_filename || f.title || '');
      const sizeMb = f.file_size_mb ? `${f.file_size_mb} MB` : '';
      const tags = f.metadata?.tags || [];

      return `
        <div class="p-3 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition cursor-pointer"
             onclick="window.openFileDetail('${f.id}')">
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-center gap-3 flex-1 min-w-0">
              <span class="text-2xl">${icon}</span>
              <div class="min-w-0 flex-1">
                <div class="font-medium text-sm truncate">${f.original_filename || f.title || 'Untitled'}</div>
                <div class="text-xs text-slate-500 flex gap-3 flex-wrap mt-0.5">
                  ${sizeMb ? `<span>${sizeMb}</span>` : ''}
                  ${f.content_length ? `<span>${f.content_length.toLocaleString()} chars</span>` : ''}
                  ${f.extracted_images_count ? `<span>üñºÔ∏è ${f.extracted_images_count} images</span>` : ''}
                  ${f.score ? `<span>Score: ${(f.score * 100).toFixed(0)}%</span>` : ''}
                </div>
                ${tags.length ? `<div class="flex gap-1 mt-1">${tags.map(t => `<span class="text-xs px-1.5 py-0.5 bg-brand-100 dark:bg-brand-900/30 text-brand-800 dark:text-brand-200 rounded">${t}</span>`).join('')}</div>` : ''}
              </div>
            </div>
            <div class="text-xs text-slate-400 whitespace-nowrap">${f.last_fetch_at ? new Date(f.last_fetch_at).toLocaleDateString() : ''}</div>
          </div>
        </div>`;
    }).join('');

    // Update pagination
    const pagination = document.getElementById('file-browser-pagination');
    pagination.classList.remove('hidden');
    document.getElementById('file-browser-info').textContent =
      `Showing ${filesOffset + 1}-${Math.min(filesOffset + filesLimit, filesTotalCount)} of ${filesTotalCount}`;
    document.getElementById('files-prev-btn').disabled = filesOffset === 0;
    document.getElementById('files-next-btn').disabled = filesOffset + filesLimit >= filesTotalCount;

  } catch (error) {
    container.innerHTML = `<p class="text-sm text-red-500">Error: ${error.message}</p>`;
  }
}

function loadFilesNext() {
  filesOffset += filesLimit;
  loadFiles(false);
}

function loadFilesPrev() {
  filesOffset = Math.max(0, filesOffset - filesLimit);
  loadFiles(false);
}

async function openFileDetail(fileId) {
  const modal = document.getElementById('file-detail-modal');
  const titleEl = document.getElementById('file-detail-title');
  const contentEl = document.getElementById('file-detail-content');

  modal.classList.remove('hidden');
  titleEl.textContent = 'Loading...';
  contentEl.innerHTML = '<p class="text-sm text-slate-500">Loading file details...</p>';

  try {
    const file = await fetchJSON(`/api/local-data/files/${fileId}`);

    titleEl.textContent = file.original_filename || file.title || 'File Detail';

    const meta = file.metadata || {};
    const tags = meta.tags || [];
    const notes = meta.notes || '';
    const intel = file.intelligence || [];
    const rels = file.relationships || [];
    const media = file.media_items || [];

    contentEl.innerHTML = `
      <!-- File Info -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="p-2 bg-slate-50 dark:bg-slate-800 rounded border text-center">
          <div class="text-xs text-slate-500">Type</div>
          <div class="font-semibold text-sm">${meta.file_type || 'unknown'}</div>
        </div>
        <div class="p-2 bg-slate-50 dark:bg-slate-800 rounded border text-center">
          <div class="text-xs text-slate-500">Size</div>
          <div class="font-semibold text-sm">${meta.file_size_mb ? meta.file_size_mb + ' MB' : '-'}</div>
        </div>
        <div class="p-2 bg-slate-50 dark:bg-slate-800 rounded border text-center">
          <div class="text-xs text-slate-500">Content</div>
          <div class="font-semibold text-sm">${file.content_length ? file.content_length.toLocaleString() + ' chars' : '-'}</div>
        </div>
        <div class="p-2 bg-slate-50 dark:bg-slate-800 rounded border text-center">
          <div class="text-xs text-slate-500">Confidence</div>
          <div class="font-semibold text-sm">${meta.confidence ? (meta.confidence * 100).toFixed(0) + '%' : '-'}</div>
        </div>
      </div>

      <!-- Edit Metadata -->
      <div class="border rounded-lg p-4">
        <h4 class="font-semibold mb-3">‚úèÔ∏è Edit Metadata</h4>
        <div class="space-y-3">
          <div>
            <label class="block text-xs font-medium mb-1">Title</label>
            <input type="text" id="edit-file-title" value="${escapeHtml(file.title || '')}"
                   class="w-full px-3 py-1.5 border rounded text-sm bg-white dark:bg-slate-900">
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Tags (comma-separated)</label>
            <input type="text" id="edit-file-tags" value="${tags.join(', ')}"
                   class="w-full px-3 py-1.5 border rounded text-sm bg-white dark:bg-slate-900"
                   placeholder="tag1, tag2, tag3">
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Notes</label>
            <textarea id="edit-file-notes" rows="2"
                      class="w-full px-3 py-1.5 border rounded text-sm bg-white dark:bg-slate-900"
                      placeholder="Add notes about this file...">${notes}</textarea>
          </div>
          <button onclick="window.saveFileMetadata('${fileId}')"
                  class="px-4 py-1.5 rounded bg-brand-600 text-white text-sm font-medium hover:bg-brand-500">
            üíæ Save Metadata
          </button>
          <span id="save-meta-status" class="text-xs text-green-600 ml-2 hidden">‚úì Saved</span>
        </div>
      </div>

      <!-- Content Preview -->
      ${file.content_preview ? `
      <div class="border rounded-lg p-4">
        <h4 class="font-semibold mb-2">üìÑ Content Preview</h4>
        <pre class="text-xs text-slate-600 dark:text-slate-400 whitespace-pre-wrap max-h-60 overflow-y-auto bg-slate-50 dark:bg-slate-800 p-3 rounded">${escapeHtml(file.content_preview)}</pre>
      </div>` : ''}

      <!-- Intelligence Records -->
      ${intel.length ? `
      <div class="border rounded-lg p-4">
        <h4 class="font-semibold mb-2">üß† Intelligence (${intel.length})</h4>
        <div class="space-y-2 max-h-48 overflow-y-auto">
          ${intel.map(i => `
            <div class="p-2 bg-slate-50 dark:bg-slate-800 rounded text-xs">
              <div class="flex justify-between">
                <span class="font-medium">${i.entity_name || 'Unknown'}</span>
                <span class="text-slate-500">${i.entity_type || ''} | ${i.confidence ? (i.confidence * 100).toFixed(0) + '%' : ''}</span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>` : ''}

      <!-- Relationships -->
      ${rels.length ? `
      <div class="border rounded-lg p-4">
        <h4 class="font-semibold mb-2">üîó Relationships (${rels.length})</h4>
        <div class="space-y-2 max-h-48 overflow-y-auto">
          ${rels.map(r => `
            <div class="p-2 bg-slate-50 dark:bg-slate-800 rounded text-xs flex justify-between">
              <span class="font-medium">${r.relation_type}</span>
              <span class="text-slate-500">${r.direction} ‚Üí ${r.direction === 'outgoing' ? (r.target_id || '').substring(0, 8) : (r.source_id || '').substring(0, 8)}...</span>
            </div>
          `).join('')}
        </div>
      </div>` : ''}

      <!-- Extracted Media -->
      ${media.length ? `
      <div class="border rounded-lg p-4">
        <h4 class="font-semibold mb-2">üñºÔ∏è Extracted Images (${media.length})</h4>
        <div class="space-y-2 max-h-48 overflow-y-auto">
          ${media.map(m => `
            <div class="p-2 bg-slate-50 dark:bg-slate-800 rounded text-xs">
              <div class="flex justify-between">
                <span class="font-medium">${m.url.split('/').pop()}</span>
                <span class="${m.processed ? 'text-green-600' : 'text-yellow-600'}">${m.processed ? '‚úì Processed' : '‚è≥ Pending'}</span>
              </div>
              ${m.extracted_text ? `<div class="text-slate-500 mt-1 truncate">${m.extracted_text}</div>` : ''}
            </div>
          `).join('')}
        </div>
      </div>` : ''}

      <!-- Add Relationship -->
      <div class="border rounded-lg p-4">
        <h4 class="font-semibold mb-2">‚ûï Add Relationship</h4>
        <div class="flex gap-2">
          <input type="text" id="add-rel-target" placeholder="Target entity/file UUID"
                 class="flex-1 px-3 py-1.5 border rounded text-sm bg-white dark:bg-slate-900">
          <select id="add-rel-type" class="px-3 py-1.5 border rounded text-sm">
            <option value="related_to">Related To</option>
            <option value="derived_from">Derived From</option>
            <option value="references">References</option>
            <option value="contains">Contains</option>
          </select>
          <button onclick="window.addFileRelation('${fileId}')"
                  class="px-4 py-1.5 rounded bg-brand-600 text-white text-sm font-medium hover:bg-brand-500">
            Add
          </button>
        </div>
        <div id="add-rel-status" class="text-xs mt-1 hidden"></div>
      </div>

      <!-- Download -->
      <div class="flex gap-2">
        <a href="/api/local-data/files/${fileId}/download" target="_blank"
           class="px-4 py-1.5 rounded border text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-800 inline-flex items-center gap-1">
          ‚¨áÔ∏è Download Original File
        </a>
      </div>
    `;
  } catch (error) {
    contentEl.innerHTML = `<p class="text-sm text-red-500">Error loading file: ${error.message}</p>`;
  }
}

function closeFileDetail() {
  document.getElementById('file-detail-modal').classList.add('hidden');
}

async function saveFileMetadata(fileId) {
  const title = document.getElementById('edit-file-title')?.value || '';
  const tagsStr = document.getElementById('edit-file-tags')?.value || '';
  const notes = document.getElementById('edit-file-notes')?.value || '';
  const status = document.getElementById('save-meta-status');

  const tags = tagsStr.split(',').map(t => t.trim()).filter(Boolean);

  try {
    await fetchJSON(`/api/local-data/files/${fileId}/metadata`, {
      method: 'PUT',
      body: JSON.stringify({ title, tags, notes }),
    });
    status.classList.remove('hidden');
    status.textContent = '‚úì Saved';
    status.className = 'text-xs text-green-600 ml-2';
    setTimeout(() => status.classList.add('hidden'), 3000);
    loadFiles(false);
  } catch (error) {
    status.classList.remove('hidden');
    status.textContent = '‚úó ' + error.message;
    status.className = 'text-xs text-red-600 ml-2';
  }
}

async function addFileRelation(fileId) {
  const targetId = document.getElementById('add-rel-target')?.value?.trim();
  const relType = document.getElementById('add-rel-type')?.value || 'related_to';
  const status = document.getElementById('add-rel-status');

  if (!targetId) {
    status.classList.remove('hidden');
    status.textContent = 'Please enter a target UUID';
    status.className = 'text-xs text-red-600 mt-1';
    return;
  }

  try {
    await fetchJSON(`/api/local-data/files/${fileId}/relations`, {
      method: 'POST',
      body: JSON.stringify({ target_id: targetId, relation_type: relType }),
    });
    status.classList.remove('hidden');
    status.textContent = '‚úì Relationship added';
    status.className = 'text-xs text-green-600 mt-1';
    document.getElementById('add-rel-target').value = '';
    setTimeout(() => { status.classList.add('hidden'); openFileDetail(fileId); }, 1000);
  } catch (error) {
    status.classList.remove('hidden');
    status.textContent = '‚úó ' + error.message;
    status.className = 'text-xs text-red-600 mt-1';
  }
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// Expose to global scope
window.loadFiles = loadFiles;
window.loadFilesNext = loadFilesNext;
window.loadFilesPrev = loadFilesPrev;
window.openFileDetail = openFileDetail;
window.closeFileDetail = closeFileDetail;
window.saveFileMetadata = saveFileMetadata;
window.addFileRelation = addFileRelation;

// Handle search on Enter key
document.getElementById('file-search-input')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') loadFiles();
});

// Close modal on backdrop click
document.getElementById('file-detail-modal')?.addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeFileDetail();
});

// Auto-load on page init
document.addEventListener('DOMContentLoaded', () => {
  loadSupportedTypes();
  loadWatcherStatus();
  loadLocalTasks();
  loadFiles();
});
</script>
