<div class="space-y-6">
  <!-- Unified Search Interface -->
  <article class="card-surface rounded-xl border border-slate-200/70 dark:border-slate-800 bg-white/80 dark:bg-slate-900/70 p-5 space-y-4">
    <div class="flex items-center justify-between flex-wrap gap-3">
      <div>
        <h3 class="text-xl font-bold text-slate-900 dark:text-white">üîç Unified Search</h3>
        <p class="text-sm text-slate-600 dark:text-slate-400">All search modes in one place - SQL, Semantic, RAG, AI Chat, Entity Search</p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button id="search-mode-toggle-sql" class="px-3 py-1 text-xs font-bold rounded-lg transition bg-brand-600 text-white">SQL</button>
        <button id="search-mode-toggle-semantic" class="px-3 py-1 text-xs font-bold rounded-lg transition bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 border border-slate-200 dark:border-slate-700">Semantic</button>
        <button id="search-mode-toggle-rag" class="px-3 py-1 text-xs font-bold rounded-lg transition bg-white dark:bg-slate-900 text-purple-700 dark:text-purple-300 border border-purple-300 dark:border-purple-700">üß† RAG</button>
        <button id="search-mode-toggle-chat" class="px-3 py-1 text-xs font-bold rounded-lg transition bg-white dark:bg-slate-900 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700">üí¨ AI Chat</button>
        <button id="search-mode-toggle-entity" class="px-3 py-1 text-xs font-bold rounded-lg transition bg-white dark:bg-slate-900 text-indigo-700 dark:text-indigo-300 border border-indigo-300 dark:border-indigo-700">üè∑Ô∏è Entity</button>
      </div>
    </div>
    
    <!-- SQL Search Form -->
    <div id="sql-search-form-container">
      <form id="search-form" class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1 text-slate-800 dark:text-slate-100">Search Query</label>
          <input id="q" name="q" type="search" placeholder="keyword or entity" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm text-slate-900 dark:text-slate-100 focus:border-brand-500 focus:ring-brand-500"/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1 text-slate-800 dark:text-slate-100">Entity (optional)</label>
          <input id="entity" name="entity" type="text" placeholder="Filter by entity name" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm text-slate-900 dark:text-slate-100 focus:border-brand-500 focus:ring-brand-500"/>
        </div>
        <div class="grid gap-3 sm:grid-cols-2">
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Min confidence
            <input id="min_conf" name="min_conf" type="number" min="0" max="1" step="0.05" value="0" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-brand-500 focus:ring-brand-500"/>
          </label>
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Limit
            <input id="limit" name="limit" type="number" min="1" max="200" value="50" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-brand-500 focus:ring-brand-500"/>
          </label>
        </div>
        <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-brand-600 text-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500">
          Search SQL
        </button>
      </form>
    </div>
    
    <!-- Semantic Search Form -->
    <div id="semantic-search-form-container" class="hidden">
      <form id="semantic-form" class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1 text-slate-800 dark:text-slate-100">Semantic Query</label>
          <input id="semantic-q" type="search" placeholder="Natural language query for vector search" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm text-slate-900 dark:text-slate-100 focus:border-brand-500 focus:ring-brand-500"/>
        </div>
        <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
          Top K Results
          <input id="semantic-topk" type="number" min="1" max="50" value="10" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-brand-500 focus:ring-brand-500"/>
        </label>
        <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-brand-600 text-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500">
          Search Semantic
        </button>
      </form>
    </div>
    
    <!-- Advanced RAG Search Form (Multidimensional: Embedding + Graph) -->
    <div id="rag-search-form-container" class="hidden">
      <div class="p-3 mb-3 rounded-lg bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800">
        <p class="text-xs text-purple-800 dark:text-purple-200">
          <strong>üß† Advanced RAG</strong> combines embedding-based semantic search with entity graph traversal for multidimensional results.
        </p>
      </div>
      <form id="rag-form" class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1 text-slate-800 dark:text-slate-100">Query</label>
          <input id="rag-q" type="search" placeholder="Natural language query for multidimensional search" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm text-slate-900 dark:text-slate-100 focus:border-purple-500 focus:ring-purple-500"/>
        </div>
        <div class="grid gap-3 sm:grid-cols-3">
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Top K Results
            <input id="rag-topk" type="number" min="1" max="50" value="10" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-purple-500 focus:ring-purple-500"/>
          </label>
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Graph Depth
            <input id="rag-graph-depth" type="number" min="1" max="5" value="2" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-purple-500 focus:ring-purple-500"/>
          </label>
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100 flex flex-col">
            Include Graph
            <select id="rag-include-graph" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-purple-500 focus:ring-purple-500">
              <option value="true">Yes - Full Multidimensional</option>
              <option value="false">No - Embedding Only</option>
            </select>
          </label>
        </div>
        <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-purple-600 text-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500">
          üß† Search Advanced RAG
        </button>
      </form>
    </div>
    
    <!-- AI Chat Mode Form -->
    <div id="chat-search-form-container" class="hidden">
      <div class="p-3 mb-3 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800">
        <p class="text-xs text-green-800 dark:text-green-200">
          <strong>üí¨ AI Chat Mode</strong> - Deep RAG Chat combines embedding similarity, entity graph traversal, and SQL keyword search with autonomous web crawling if needed.
        </p>
      </div>
      <form id="search-tab-chat-form" class="space-y-3">
        <label class="space-y-2 text-sm font-medium text-slate-800 dark:text-slate-100">
          Question
          <textarea id="search-tab-chat-q" rows="3" placeholder="Ask a question about collected intel" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm text-slate-900 dark:text-slate-100 focus:border-brand-500 focus:ring-brand-500"></textarea>
        </label>
        <div class="grid gap-3 sm:grid-cols-2">
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Entity (optional)
            <input id="search-tab-chat-entity" type="text" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-brand-500 focus:ring-brand-500"/>
          </label>
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Top K
            <input id="search-tab-chat-topk" type="number" min="1" max="20" value="6" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-brand-500 focus:ring-brand-500"/>
          </label>
        </div>
        <div class="grid gap-3 sm:grid-cols-3">
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Max Search Cycles
            <input id="search-tab-chat-max-cycles" type="number" min="1" max="10" value="3" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-brand-500 focus:ring-brand-500"/>
          </label>
          <label class="flex items-center space-x-2 pt-6">
            <input id="search-tab-chat-autonomous-mode" type="checkbox" class="rounded border-slate-300 dark:border-slate-700 text-brand-600 focus:ring-brand-500"/>
            <span class="text-sm font-medium text-slate-800 dark:text-slate-100">ü§ñ Auto</span>
          </label>
          <label class="flex items-center space-x-2 pt-6">
            <input id="search-tab-chat-use-planner" type="checkbox" checked class="rounded border-slate-300 dark:border-slate-700 text-brand-600 focus:ring-brand-500"/>
            <span class="text-sm font-medium text-slate-800 dark:text-slate-100">üß© Planner</span>
          </label>
        </div>
        <div class="flex items-center space-x-4 mt-2">
          <label class="flex items-center space-x-2">
            <input id="search-tab-chat-crawl-enabled" type="checkbox" checked class="rounded border-slate-300 dark:border-slate-700 text-brand-600 focus:ring-brand-500"/>
            <span class="text-sm font-medium text-slate-800 dark:text-slate-100">üåê Online Crawl</span>
          </label>
        </div>
        <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-green-600 text-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-green-500 focus:outline-none focus:ring-2 focus:ring-green-500">
          üí¨ Ask AI
        </button>
      </form>
    </div>
    
    <!-- Entity Search Form -->
    <div id="entity-search-form-container" class="hidden">
      <div class="p-3 mb-3 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800">
        <p class="text-xs text-indigo-800 dark:text-indigo-200">
          <strong>üè∑Ô∏è Entity Search</strong> - Search entities using hybrid SQL + semantic similarity. Find "Microsoft" even when searching "Microsoft Corp".
        </p>
      </div>
      <form id="entity-form" class="space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1 text-slate-800 dark:text-slate-100">Search Query</label>
            <input type="text" id="entity-search-query" 
                   class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm"
                   placeholder="e.g., Microsoft Corporation">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 text-slate-800 dark:text-slate-100">Entity Type</label>
            <select id="entity-search-kind" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm">
              <option value="">Any Type</option>
              <option value="company">Company</option>
              <option value="person">Person</option>
              <option value="location">Location</option>
              <option value="product">Product</option>
              <option value="organization">Organization</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 text-slate-800 dark:text-slate-100">Similarity Threshold</label>
            <div class="flex items-center gap-2">
              <input type="range" id="entity-search-threshold" min="0.5" max="1.0" step="0.05" value="0.7" 
                     class="flex-1" onchange="document.getElementById('entity-threshold-val').textContent = this.value">
              <span id="entity-threshold-val" class="text-sm font-mono w-10">0.7</span>
            </div>
          </div>
        </div>
        <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-indigo-600 text-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          üè∑Ô∏è Search Entities
        </button>
      </form>
    </div>
    
    <!-- Results Container -->
    <div class="space-y-4">
      <div id="sql-results-container">
        <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">SQL Results</h4>
        <div id="results" class="grid gap-3"></div>
      </div>
      
      <div id="semantic-results-container" class="hidden">
        <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Semantic Results</h4>
        <div id="semantic-results" class="grid gap-3"></div>
      </div>
      
      <div id="rag-results-container" class="hidden">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-sm font-bold text-purple-700 dark:text-purple-300">üß† Advanced RAG Results</h4>
          <div id="rag-stats" class="text-xs text-slate-500 dark:text-slate-400"></div>
        </div>
        <div id="rag-results" class="grid gap-3"></div>
      </div>
      
      <div id="chat-results-container" class="hidden">
        <h4 class="text-sm font-bold text-green-700 dark:text-green-300 mb-2">üí¨ AI Chat Answer</h4>
        <div id="search-tab-chat-answer" class="space-y-3"></div>
      </div>
      
      <div id="entity-results-container" class="hidden">
        <h4 class="text-sm font-bold text-indigo-700 dark:text-indigo-300 mb-2">üè∑Ô∏è Entity Search Results</h4>
        <div id="entity-search-results" class="grid gap-3"></div>
      </div>
    </div>
  </article>
</div>

<script>
// Search mode toggle
document.addEventListener('DOMContentLoaded', () => {
  const sqlBtn = document.getElementById('search-mode-toggle-sql');
  const semanticBtn = document.getElementById('search-mode-toggle-semantic');
  const ragBtn = document.getElementById('search-mode-toggle-rag');
  const chatBtn = document.getElementById('search-mode-toggle-chat');
  const entityBtn = document.getElementById('search-mode-toggle-entity');
  
  const sqlForm = document.getElementById('sql-search-form-container');
  const semanticForm = document.getElementById('semantic-search-form-container');
  const ragForm = document.getElementById('rag-search-form-container');
  const chatForm = document.getElementById('chat-search-form-container');
  const entityForm = document.getElementById('entity-search-form-container');
  
  const sqlResults = document.getElementById('sql-results-container');
  const semanticResults = document.getElementById('semantic-results-container');
  const ragResults = document.getElementById('rag-results-container');
  const chatResults = document.getElementById('chat-results-container');
  const entityResults = document.getElementById('entity-results-container');
  
  function setMode(mode) {
    // Reset all button styles
    const allButtons = [sqlBtn, semanticBtn, ragBtn, chatBtn, entityBtn];
    allButtons.forEach(btn => {
      btn.classList.remove('bg-brand-600', 'bg-purple-600', 'bg-green-600', 'bg-indigo-600', 'text-white');
      btn.classList.add('bg-white', 'dark:bg-slate-900', 'border');
    });
    
    // Reset specific colors
    ragBtn.classList.add('text-purple-700', 'dark:text-purple-300', 'border-purple-300', 'dark:border-purple-700');
    chatBtn.classList.add('text-green-700', 'dark:text-green-300', 'border-green-300', 'dark:border-green-700');
    entityBtn.classList.add('text-indigo-700', 'dark:text-indigo-300', 'border-indigo-300', 'dark:border-indigo-700');
    sqlBtn.classList.add('text-slate-800', 'dark:text-slate-100', 'border-slate-200', 'dark:border-slate-700');
    semanticBtn.classList.add('text-slate-800', 'dark:text-slate-100', 'border-slate-200', 'dark:border-slate-700');
    
    // Hide all forms and results
    [sqlForm, semanticForm, ragForm, chatForm, entityForm].forEach(f => f?.classList.add('hidden'));
    [sqlResults, semanticResults, ragResults, chatResults, entityResults].forEach(r => r?.classList.add('hidden'));
    
    // Show selected mode
    if (mode === 'sql') {
      sqlBtn.classList.add('bg-brand-600', 'text-white');
      sqlBtn.classList.remove('bg-white', 'dark:bg-slate-900', 'text-slate-800', 'dark:text-slate-100', 'border');
      sqlForm?.classList.remove('hidden');
      sqlResults?.classList.remove('hidden');
    } else if (mode === 'semantic') {
      semanticBtn.classList.add('bg-brand-600', 'text-white');
      semanticBtn.classList.remove('bg-white', 'dark:bg-slate-900', 'text-slate-800', 'dark:text-slate-100', 'border');
      semanticForm?.classList.remove('hidden');
      semanticResults?.classList.remove('hidden');
    } else if (mode === 'rag') {
      ragBtn.classList.add('bg-purple-600', 'text-white');
      ragBtn.classList.remove('bg-white', 'dark:bg-slate-900', 'text-purple-700', 'dark:text-purple-300', 'border');
      ragForm?.classList.remove('hidden');
      ragResults?.classList.remove('hidden');
    } else if (mode === 'chat') {
      chatBtn.classList.add('bg-green-600', 'text-white');
      chatBtn.classList.remove('bg-white', 'dark:bg-slate-900', 'text-green-700', 'dark:text-green-300', 'border');
      chatForm?.classList.remove('hidden');
      chatResults?.classList.remove('hidden');
    } else if (mode === 'entity') {
      entityBtn.classList.add('bg-indigo-600', 'text-white');
      entityBtn.classList.remove('bg-white', 'dark:bg-slate-900', 'text-indigo-700', 'dark:text-indigo-300', 'border');
      entityForm?.classList.remove('hidden');
      entityResults?.classList.remove('hidden');
    }
    
    localStorage.setItem('garuda_search_mode', mode);
  }
  
  sqlBtn?.addEventListener('click', () => setMode('sql'));
  semanticBtn?.addEventListener('click', () => setMode('semantic'));
  ragBtn?.addEventListener('click', () => setMode('rag'));
  chatBtn?.addEventListener('click', () => setMode('chat'));
  entityBtn?.addEventListener('click', () => setMode('entity'));
  
  // Load saved mode
  const savedMode = localStorage.getItem('garuda_search_mode') || 'sql';
  setMode(savedMode);
  
  // Advanced RAG form submission
  const ragSearchForm = document.getElementById('rag-form');
  if (ragSearchForm) {
    ragSearchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const query = document.getElementById('rag-q').value.trim();
      const topK = parseInt(document.getElementById('rag-topk').value) || 10;
      const graphDepth = parseInt(document.getElementById('rag-graph-depth').value) || 2;
      const includeGraph = document.getElementById('rag-include-graph').value === 'true';
      
      if (!query) {
        alert('Please enter a query');
        return;
      }
      
      const resultsContainer = document.getElementById('rag-results');
      const statsContainer = document.getElementById('rag-stats');
      resultsContainer.innerHTML = '<div class="text-sm text-slate-500 p-4">üîÑ Searching with Advanced RAG...</div>';
      statsContainer.innerHTML = '';
      
      try {
        const response = await fetch('/api/agent/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: query,
            top_k: topK,
            include_graph: includeGraph,
            graph_depth: graphDepth
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          resultsContainer.innerHTML = `<div class="text-sm text-red-500 p-4">Error: ${data.error}</div>`;
          return;
        }
        
        // Show statistics
        const stats = data.statistics || {};
        statsContainer.innerHTML = `
          <span class="inline-block px-2 py-0.5 rounded bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 mr-2">Embedding: ${stats.embedding_hits || 0}</span>
          <span class="inline-block px-2 py-0.5 rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 mr-2">Graph: ${stats.graph_hits || 0}</span>
          <span class="inline-block px-2 py-0.5 rounded bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">Total: ${stats.unique_results || 0}</span>
        `;
        
        // Render results
        const results = data.combined_results || [];
        if (results.length === 0) {
          resultsContainer.innerHTML = '<div class="text-sm text-slate-500 p-4">No results found</div>';
          return;
        }
        
        resultsContainer.innerHTML = results.map((r, i) => {
          const source = r.source || 'unknown';
          const sourceClass = source === 'embedding' 
            ? 'border-purple-200 dark:border-purple-800 bg-purple-50 dark:bg-purple-900/20' 
            : 'border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20';
          const sourceLabel = source === 'embedding' ? 'üß† Embedding' : 'üï∏Ô∏è Graph';
          const score = r.combined_score || r.score || 0;
          
          return `
            <div class="p-3 rounded-lg border ${sourceClass}">
              <div class="flex justify-between items-start mb-2">
                <span class="text-xs font-semibold">${sourceLabel}</span>
                <span class="text-xs text-slate-500">Score: ${score.toFixed(3)}</span>
              </div>
              ${r.entity ? `<div class="text-sm font-medium text-slate-900 dark:text-white mb-1">${r.entity}</div>` : ''}
              ${r.url ? `<div class="text-xs text-brand-600 dark:text-brand-400 truncate mb-1">${r.url}</div>` : ''}
              ${r.text ? `<p class="text-xs text-slate-600 dark:text-slate-400 line-clamp-3">${r.text.substring(0, 300)}${r.text.length > 300 ? '...' : ''}</p>` : ''}
            </div>
          `;
        }).join('');
        
      } catch (err) {
        resultsContainer.innerHTML = `<div class="text-sm text-red-500 p-4">Error: ${err.message}</div>`;
      }
    });
  }
  
  // Entity Search form submission
  const entitySearchForm = document.getElementById('entity-form');
  if (entitySearchForm) {
    entitySearchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const query = document.getElementById('entity-search-query').value;
      const kind = document.getElementById('entity-search-kind').value;
      const threshold = parseFloat(document.getElementById('entity-search-threshold').value);
      
      if (!query) {
        alert('Please enter a search query');
        return;
      }
      
      if (window.searchEntitiesSemantic) {
        window.searchEntitiesSemantic(query, { kind, threshold });
      } else {
        alert('Entity search functionality not loaded. Please refresh the page.');
      }
    });
  }
});
</script>
