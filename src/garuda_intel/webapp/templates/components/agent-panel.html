<div class="space-y-6">
  <!-- Agent Control Panel -->
  <article class="card-surface rounded-xl border border-purple-200 dark:border-purple-800 bg-white/80 dark:bg-slate-900/70 p-5 space-y-4">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-xl font-bold text-purple-800 dark:text-purple-200">ü§ñ Agent Control Panel</h3>
        <p class="text-sm text-slate-600 dark:text-slate-400">Intelligent data exploration, entity management, and quality analysis</p>
      </div>
      <div id="agent-status-badge" class="px-3 py-1 text-xs font-bold rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">
        Agent Active
      </div>
    </div>
    
    <!-- Agent Mode Tabs -->
    <div class="border-b border-slate-200 dark:border-slate-700">
      <nav class="flex gap-4 -mb-px">
        <button id="agent-tab-reflect" class="agent-tab px-4 py-2 text-sm font-medium border-b-2 border-purple-600 text-purple-700 dark:text-purple-300">
          üîÑ Reflect & Refine
        </button>
        <button id="agent-tab-explore" class="agent-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">
          üó∫Ô∏è Explore Graph
        </button>
        <button id="agent-tab-autonomous" class="agent-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">
          ü§ñ Autonomous Mode
        </button>
        <button id="agent-tab-taskqueue" class="agent-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">
          üìã Task Queue
        </button>
      </nav>
    </div>
    
    <!-- Reflect & Refine Panel -->
    <div id="agent-panel-reflect" class="agent-panel space-y-4">
      <div class="p-3 rounded-lg bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800">
        <p class="text-xs text-orange-800 dark:text-orange-200">
          <strong>Reflect & Refine</strong> analyzes your data to find duplicate entities (e.g., "Microsoft Corp" vs "Microsoft Corporation"), validates data quality, and can merge duplicates.
        </p>
      </div>
      
      <form id="agent-reflect-form" class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1 text-slate-800 dark:text-slate-100">Target Entities (comma-separated, optional)</label>
          <input id="reflect-entities" type="text" placeholder="Microsoft, Apple, Google (leave empty for all)" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm text-slate-900 dark:text-slate-100 focus:border-purple-500 focus:ring-purple-500"/>
        </div>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 text-sm">
            <input id="reflect-dry-run" type="checkbox" checked class="rounded border-slate-300 text-purple-600 focus:ring-purple-500">
            <span class="text-slate-700 dark:text-slate-300">Dry Run (preview only, no changes)</span>
          </label>
        </div>
        <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-orange-600 text-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-orange-500">
          üîÑ Analyze & Reflect
        </button>
      </form>
      
      <div id="reflect-results" class="space-y-3"></div>
    </div>
    
    <!-- Explore Graph Panel -->
    <div id="agent-panel-explore" class="agent-panel hidden space-y-4">
      <div class="p-3 rounded-lg bg-teal-50 dark:bg-teal-900/20 border border-teal-200 dark:border-teal-800">
        <p class="text-xs text-teal-800 dark:text-teal-200">
          <strong>Explore Graph</strong> traverses entity relationships to find high-priority entities for further research. Entities are prioritized by relation depth and discovery potential.
        </p>
      </div>
      
      <form id="agent-explore-form" class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1 text-slate-800 dark:text-slate-100">Root Entities (comma-separated)</label>
          <input id="explore-entities" type="text" placeholder="Microsoft Corporation, Bill Gates" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm text-slate-900 dark:text-slate-100 focus:border-purple-500 focus:ring-purple-500"/>
        </div>
        <div class="grid gap-3 sm:grid-cols-2">
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Max Depth
            <input id="explore-depth" type="number" min="1" max="5" value="3" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-purple-500 focus:ring-purple-500"/>
          </label>
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Top N Results
            <input id="explore-top-n" type="number" min="5" max="100" value="20" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-purple-500 focus:ring-purple-500"/>
          </label>
        </div>
        <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-teal-600 text-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-teal-500">
          üó∫Ô∏è Explore Relations
        </button>
      </form>
      
      <div id="explore-results" class="space-y-3"></div>
    </div>
    
    <!-- Autonomous Mode Panel -->
    <div id="agent-panel-autonomous" class="agent-panel hidden space-y-4">
      <div class="p-3 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800">
        <p class="text-xs text-indigo-800 dark:text-indigo-200">
          <strong>Autonomous Mode</strong> offers 4 distinct actions: Reflect & Relate (find connections), Investigate Crawl (targeted data gathering), Combined Mode (both in sequence), and Classic Discovery (dead-ends & gaps).
        </p>
      </div>
      
      <!-- Action Selection Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <button class="autonomous-action-btn p-4 rounded-lg border-2 bg-white dark:bg-slate-800 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 text-left transition-all" data-action="reflect-relate" data-color="indigo">
          <div class="text-2xl mb-2">üîç</div>
          <div class="text-sm font-bold text-indigo-700 dark:text-indigo-300">Reflect & Relate</div>
          <div class="text-xs text-slate-600 dark:text-slate-400 mt-1">Find indirect connections & create investigation tasks</div>
        </button>
        <button class="autonomous-action-btn p-4 rounded-lg border-2 bg-white dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 text-left transition-all" data-action="investigate-crawl" data-color="blue">
          <div class="text-2xl mb-2">üï∏Ô∏è</div>
          <div class="text-sm font-bold text-blue-700 dark:text-blue-300">Investigate Crawl</div>
          <div class="text-xs text-slate-600 dark:text-slate-400 mt-1">Execute crawls based on investigation tasks</div>
        </button>
        <button class="autonomous-action-btn p-4 rounded-lg border-2 bg-white dark:bg-slate-800 hover:bg-purple-50 dark:hover:bg-purple-900/20 text-left transition-all" data-action="combined" data-color="purple">
          <div class="text-2xl mb-2">üîÑ</div>
          <div class="text-sm font-bold text-purple-700 dark:text-purple-300">Combined Mode</div>
          <div class="text-xs text-slate-600 dark:text-slate-400 mt-1">Run Reflect & Relate, then Investigate Crawl</div>
        </button>
        <button class="autonomous-action-btn p-4 rounded-lg border-2 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-left transition-all" data-action="discover" data-color="slate">
          <div class="text-2xl mb-2">ü§ñ</div>
          <div class="text-sm font-bold text-slate-700 dark:text-slate-300">Classic Discovery</div>
          <div class="text-xs text-slate-600 dark:text-slate-400 mt-1">Find dead-ends & knowledge gaps</div>
        </button>
      </div>
      
      <!-- Configuration Panel -->
      <form id="agent-autonomous-form" class="space-y-3 p-4 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700">
        <div class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">
          Configuration for: <span id="selected-action-label" class="text-indigo-600 dark:text-indigo-400">Reflect & Relate</span>
        </div>
        
        <!-- Common Options -->
        <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Max Entities
            <input id="autonomous-max-entities" type="number" min="1" max="50" value="10" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-indigo-500 focus:ring-indigo-500"/>
          </label>
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Priority Threshold
            <input id="autonomous-priority-threshold" type="number" min="0" max="1" step="0.05" value="0.3" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-indigo-500 focus:ring-indigo-500"/>
          </label>
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Max Depth
            <input id="autonomous-max-depth" type="number" min="1" max="5" value="3" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-indigo-500 focus:ring-indigo-500"/>
          </label>
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Max Pages per Crawl
            <input id="autonomous-max-pages" type="number" min="5" max="100" value="25" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-indigo-500 focus:ring-indigo-500"/>
          </label>
        </div>
        
        <!-- Action-specific options -->
        <div id="reflect-relate-options" class="space-y-3">
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Target Entities (comma-separated, optional)
            <input id="autonomous-target-entities" type="text" placeholder="Apple, Microsoft" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-indigo-500 focus:ring-indigo-500"/>
          </label>
          <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
            Top N Relations
            <input id="autonomous-top-n" type="number" min="5" max="50" value="20" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-indigo-500 focus:ring-indigo-500"/>
          </label>
        </div>
        
        <div id="discover-options" class="hidden">
          <label class="flex items-center gap-2 text-sm">
            <input id="autonomous-auto-crawl" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <span class="text-slate-700 dark:text-slate-300">Enable Autonomous Crawling</span>
          </label>
        </div>
        
        <button type="submit" id="autonomous-run-btn" class="inline-flex items-center justify-center rounded-lg bg-indigo-600 text-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-indigo-500">
          üîç Run Reflect & Relate
        </button>
      </form>
      
      <!-- Automatic Mode Toggle -->
      <div class="p-4 rounded-lg bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 border border-purple-200 dark:border-purple-800">
        <div class="flex items-center justify-between">
          <div>
            <h5 class="text-sm font-bold text-purple-800 dark:text-purple-200">üîÅ Automatic Mode</h5>
            <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">
              Continuously runs Combined Mode (Reflect &amp; Relate ‚Üí Investigate Crawl) in a loop until stopped. Automatically searches for dead ends, potential relations, and webcrawls.
            </p>
          </div>
          <div class="flex items-center gap-3">
            <span id="auto-mode-status" class="text-xs font-medium text-slate-500 dark:text-slate-400">Stopped</span>
            <label class="relative inline-flex items-center cursor-pointer">
              <input id="auto-mode-toggle" type="checkbox" class="sr-only peer">
              <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:after:border-slate-600 peer-checked:bg-purple-600"></div>
            </label>
          </div>
        </div>
        <div id="auto-mode-log" class="hidden mt-3 space-y-2 max-h-60 overflow-y-auto"></div>
      </div>
      
      <!-- Process Monitor Panel -->
      <div id="process-monitor" class="hidden p-4 rounded-lg bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800">
        <div class="flex items-center justify-between mb-3">
          <h5 class="text-sm font-bold text-amber-800 dark:text-amber-200">‚öôÔ∏è Running Processes</h5>
          <button id="refresh-processes-btn" class="text-xs px-2 py-1 rounded bg-amber-600 text-white hover:bg-amber-500">Refresh</button>
        </div>
        <div id="process-list" class="space-y-2"></div>
      </div>
      
      <!-- Results Panel -->
      <div id="autonomous-results" class="space-y-3"></div>
    </div>
    
    <!-- Task Queue Panel -->
    <div id="agent-panel-taskqueue" class="agent-panel hidden space-y-4">
      <div class="p-3 rounded-lg bg-cyan-50 dark:bg-cyan-900/20 border border-cyan-200 dark:border-cyan-800">
        <p class="text-xs text-cyan-800 dark:text-cyan-200">
          <strong>Task Queue</strong> shows all persistent tasks (LLM operations, crawls, agent actions). Tasks survive page reloads and server restarts. The queue processes one LLM task at a time to protect the Ollama instance.
        </p>
      </div>
      
      <!-- Queue Stats -->
      <div id="tq-stats" class="grid grid-cols-2 sm:grid-cols-5 gap-3">
        <div class="p-3 rounded-lg bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 text-center">
          <div id="tq-stat-pending" class="text-2xl font-bold text-amber-700 dark:text-amber-300">-</div>
          <div class="text-xs text-amber-600 dark:text-amber-400">Pending</div>
        </div>
        <div class="p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 text-center">
          <div id="tq-stat-running" class="text-2xl font-bold text-blue-700 dark:text-blue-300">-</div>
          <div class="text-xs text-blue-600 dark:text-blue-400">Running</div>
        </div>
        <div class="p-3 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-center">
          <div id="tq-stat-completed" class="text-2xl font-bold text-green-700 dark:text-green-300">-</div>
          <div class="text-xs text-green-600 dark:text-green-400">Completed</div>
        </div>
        <div class="p-3 rounded-lg bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 text-center">
          <div id="tq-stat-failed" class="text-2xl font-bold text-rose-700 dark:text-rose-300">-</div>
          <div class="text-xs text-rose-600 dark:text-rose-400">Failed</div>
        </div>
        <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 text-center">
          <div id="tq-stat-cancelled" class="text-2xl font-bold text-slate-700 dark:text-slate-300">-</div>
          <div class="text-xs text-slate-600 dark:text-slate-400">Cancelled</div>
        </div>
      </div>
      
      <!-- Controls -->
      <div class="flex items-center gap-3">
        <button id="tq-refresh-btn" class="inline-flex items-center rounded-lg bg-cyan-600 text-white px-3 py-1.5 text-sm font-medium shadow-sm hover:bg-cyan-500">
          üîÑ Refresh
        </button>
        <select id="tq-filter-status" class="rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-cyan-500">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="running">Running</option>
          <option value="completed">Completed</option>
          <option value="failed">Failed</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <label class="flex items-center gap-2 text-sm">
          <input id="tq-auto-refresh" type="checkbox" checked class="rounded border-slate-300 text-cyan-600 focus:ring-cyan-500">
          <span class="text-slate-700 dark:text-slate-300">Auto-refresh</span>
        </label>
      </div>
      
      <!-- Task List -->
      <div id="tq-task-list" class="space-y-2">
        <div class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">Loading tasks...</div>
      </div>
    </div>
  </article>

  <!-- Agent Multidimensional Search -->
  <article class="card-surface rounded-xl border border-purple-200 dark:border-purple-800 bg-white/80 dark:bg-slate-900/70 p-5 space-y-4">
    <h3 class="text-lg font-bold text-purple-800 dark:text-purple-200">üîç Agent Multidimensional Search</h3>
    <p class="text-xs text-slate-600 dark:text-slate-400">Combines embedding-based semantic search with entity graph traversal for multidimensional results.</p>
    <form id="agent-search-form" class="space-y-3">
      <div>
        <label class="block text-sm font-medium mb-1 text-slate-800 dark:text-slate-100">Search Query</label>
        <input id="agent-search-q" type="search" placeholder="Natural language query for multidimensional search" class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm text-slate-900 dark:text-slate-100 focus:border-purple-500 focus:ring-purple-500"/>
      </div>
      <div class="grid gap-3 sm:grid-cols-3">
        <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
          Top K Results
          <input id="agent-search-topk" type="number" min="1" max="50" value="10" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-purple-500 focus:ring-purple-500"/>
        </label>
        <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100">
          Graph Depth
          <input id="agent-search-depth" type="number" min="1" max="5" value="2" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-purple-500 focus:ring-purple-500"/>
        </label>
        <label class="space-y-1 text-sm font-medium text-slate-800 dark:text-slate-100 flex flex-col">
          Include Graph
          <select id="agent-search-graph" class="mt-1 w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:border-purple-500 focus:ring-purple-500">
            <option value="true">Yes - Full Multidimensional</option>
            <option value="false">No - Embedding Only</option>
          </select>
        </label>
      </div>
      <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-purple-600 text-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-purple-500">
        üîç Search
      </button>
    </form>
    <div id="agent-search-results" class="space-y-3"></div>
  </article>
</div>

<script type="module">
import { getApiKey } from '/static/storage.js';
import { submitAndPoll, cancelTask, renderTaskStatus, getActiveTasks, pollTaskResult } from '/static/task-poller.js';

/**
 * Helper: Submit an agent operation via the task queue and render results.
 * All operations go through the persistent queue for:
 * - Surviving page reloads
 * - Sequential LLM processing (protecting Ollama)
 * - Task cancellation support
 */
async function runQueuedOperation(endpoint, body, resultsContainer, renderFn) {
  try {
    const result = await submitAndPoll(endpoint, body, {
      statusElement: resultsContainer,
    });
    renderFn(result);
  } catch (err) {
    resultsContainer.innerHTML = `<div class="text-sm text-red-500 p-4">Error: ${err.message}</div>`;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // Tab switching
  const tabs = document.querySelectorAll('.agent-tab');
  const panels = document.querySelectorAll('.agent-panel');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const targetPanel = tab.id.replace('agent-tab-', 'agent-panel-');
      
      // Reset all tabs
      tabs.forEach(t => {
        t.classList.remove('border-purple-600', 'text-purple-700', 'dark:text-purple-300');
        t.classList.add('border-transparent', 'text-slate-600', 'dark:text-slate-400');
      });
      
      // Activate clicked tab
      tab.classList.add('border-purple-600', 'text-purple-700', 'dark:text-purple-300');
      tab.classList.remove('border-transparent', 'text-slate-600', 'dark:text-slate-400');
      
      // Show/hide panels
      panels.forEach(panel => {
        if (panel.id === targetPanel) {
          panel.classList.remove('hidden');
        } else {
          panel.classList.add('hidden');
        }
      });
    });
  });
  
  // Reflect Form - uses task queue for persistent execution
  const reflectForm = document.getElementById('agent-reflect-form');
  reflectForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const entitiesInput = document.getElementById('reflect-entities').value.trim();
    const dryRun = document.getElementById('reflect-dry-run').checked;
    
    const targetEntities = entitiesInput ? entitiesInput.split(',').map(e => e.trim()).filter(e => e) : null;
    
    const resultsContainer = document.getElementById('reflect-results');
    
    await runQueuedOperation('/api/agent/reflect', {
      target_entities: targetEntities,
      dry_run: dryRun,
    }, resultsContainer, (data) => {
      const stats = data.statistics || {};
      const duplicates = data.duplicates_found || [];
      const issues = data.data_quality_issues || [];
      
      resultsContainer.innerHTML = `
        <div class="space-y-4">
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-800 text-center">
              <div class="text-2xl font-bold text-slate-900 dark:text-white">${stats.entities_before || 0}</div>
              <div class="text-xs text-slate-500">Entities Before</div>
            </div>
            <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-800 text-center">
              <div class="text-2xl font-bold text-slate-900 dark:text-white">${stats.entities_after || stats.entities_before || 0}</div>
              <div class="text-xs text-slate-500">Entities After</div>
            </div>
            <div class="p-3 rounded-lg bg-orange-50 dark:bg-orange-900/20 text-center">
              <div class="text-2xl font-bold text-orange-700 dark:text-orange-300">${duplicates.length}</div>
              <div class="text-xs text-orange-600 dark:text-orange-400">Duplicate Groups</div>
            </div>
            <div class="p-3 rounded-lg bg-red-50 dark:bg-red-900/20 text-center">
              <div class="text-2xl font-bold text-red-700 dark:text-red-300">${issues.length}</div>
              <div class="text-xs text-red-600 dark:text-red-400">Quality Issues</div>
            </div>
          </div>
          
          ${dryRun ? '<div class="text-xs text-amber-600 dark:text-amber-400 p-2 bg-amber-50 dark:bg-amber-900/20 rounded">üîí Dry Run - No changes were made</div>' : ''}
          
          ${duplicates.length > 0 ? `
            <div>
              <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Duplicate Groups Found</h5>
              <div class="space-y-2 max-h-60 overflow-y-auto">
                ${duplicates.slice(0, 10).map(group => `
                  <div class="p-2 rounded border border-orange-200 dark:border-orange-800 bg-orange-50 dark:bg-orange-900/10 text-xs">
                    <div class="font-medium text-orange-800 dark:text-orange-200 mb-1">${group.normalized_name} (${group.count} entities)</div>
                    <div class="text-slate-600 dark:text-slate-400">
                      ${(group.entities || []).map(e => `${e.name} (${e.kind || 'unknown'})`).join(', ')}
                    </div>
                  </div>
                `).join('')}
                ${duplicates.length > 10 ? `<div class="text-xs text-slate-500">... and ${duplicates.length - 10} more groups</div>` : ''}
              </div>
            </div>
          ` : ''}
          
          ${issues.length > 0 ? `
            <div>
              <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Quality Issues</h5>
              <div class="space-y-2 max-h-60 overflow-y-auto">
                ${issues.slice(0, 10).map(issue => `
                  <div class="p-2 rounded border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/10 text-xs">
                    <div class="font-medium text-red-800 dark:text-red-200">${issue.entity_name}</div>
                    <ul class="text-red-600 dark:text-red-400 list-disc list-inside">
                      ${(issue.issues || []).map(i => `<li>${i}</li>`).join('')}
                    </ul>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    });
  });
  
  // Explore Form - uses task queue for persistent execution
  const exploreForm = document.getElementById('agent-explore-form');
  exploreForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const entitiesInput = document.getElementById('explore-entities').value.trim();
    const maxDepth = parseInt(document.getElementById('explore-depth').value) || 3;
    const topN = parseInt(document.getElementById('explore-top-n').value) || 20;
    
    if (!entitiesInput) {
      alert('Please enter at least one root entity');
      return;
    }
    
    const rootEntities = entitiesInput.split(',').map(e => e.trim()).filter(e => e);
    
    const resultsContainer = document.getElementById('explore-results');
    
    await runQueuedOperation('/api/agent/explore', {
      root_entities: rootEntities,
      max_depth: maxDepth,
      top_n: topN,
    }, resultsContainer, (data) => {
      const stats = data.statistics || {};
      const prioritized = data.prioritized_entities || [];
      
      resultsContainer.innerHTML = `
        <div class="space-y-4">
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="p-3 rounded-lg bg-teal-50 dark:bg-teal-900/20 text-center">
              <div class="text-2xl font-bold text-teal-700 dark:text-teal-300">${stats.unique_entities || 0}</div>
              <div class="text-xs text-teal-600 dark:text-teal-400">Unique Entities</div>
            </div>
            <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-800 text-center">
              <div class="text-2xl font-bold text-slate-900 dark:text-white">${stats.max_depth_reached || 0}</div>
              <div class="text-xs text-slate-500">Max Depth Reached</div>
            </div>
            <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-800 text-center">
              <div class="text-2xl font-bold text-slate-900 dark:text-white">${stats.relations_traversed || 0}</div>
              <div class="text-xs text-slate-500">Relations Traversed</div>
            </div>
            <div class="p-3 rounded-lg bg-purple-50 dark:bg-purple-900/20 text-center">
              <div class="text-2xl font-bold text-purple-700 dark:text-purple-300">${prioritized.length}</div>
              <div class="text-xs text-purple-600 dark:text-purple-400">Prioritized</div>
            </div>
          </div>
          
          ${prioritized.length > 0 ? `
            <div>
              <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">High-Priority Entities for Research</h5>
              <div class="overflow-x-auto">
                <table class="w-full text-xs">
                  <thead class="bg-slate-100 dark:bg-slate-800">
                    <tr>
                      <th class="px-2 py-1 text-left">Entity</th>
                      <th class="px-2 py-1 text-left">Kind</th>
                      <th class="px-2 py-1 text-center">Depth</th>
                      <th class="px-2 py-1 text-center">Relations</th>
                      <th class="px-2 py-1 text-center">Priority</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    ${prioritized.map((entity, i) => `
                      <tr class="${i % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-slate-50 dark:bg-slate-800/50'}">
                        <td class="px-2 py-1 font-medium text-slate-900 dark:text-white">${entity.name || 'Unknown'}</td>
                        <td class="px-2 py-1 text-slate-600 dark:text-slate-400">${entity.kind || '-'}</td>
                        <td class="px-2 py-1 text-center">${entity.depth_from_root || 0}</td>
                        <td class="px-2 py-1 text-center">${entity.relation_count || 0}</td>
                        <td class="px-2 py-1 text-center">
                          <span class="inline-block px-2 py-0.5 rounded bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 font-medium">
                            ${(entity.priority_score || 0).toFixed(3)}
                          </span>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          ` : '<div class="text-sm text-slate-500 p-4">No entities found to explore</div>'}
        </div>
      `;
    });
  });
  
  // Search Form
  const searchForm = document.getElementById('agent-search-form');
  if (searchForm) {
    searchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const query = document.getElementById('agent-search-q').value.trim();
      const topK = parseInt(document.getElementById('agent-search-topk').value) || 10;
      const graphDepth = parseInt(document.getElementById('agent-search-depth').value) || 2;
      const includeGraph = document.getElementById('agent-search-graph').value === 'true';
      
      if (!query) {
        alert('Please enter a search query');
        return;
      }
      
      const resultsContainer = document.getElementById('agent-search-results');
      if (!resultsContainer) return;
      resultsContainer.innerHTML = '<div class="text-sm text-purple-600 p-4">üîç Searching multidimensionally...</div>';
      
      try {
        const headers = { 'Content-Type': 'application/json' };
        const apiKey = getApiKey();
        if (apiKey) headers['X-API-Key'] = apiKey;
        
        const response = await fetch('/api/agent/search', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            query: query,
            top_k: topK,
            include_graph: includeGraph,
            graph_depth: graphDepth
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          resultsContainer.innerHTML = `<div class="text-sm text-red-500 p-4">Error: ${data.error}</div>`;
          return;
        }
        
        const stats = data.statistics || {};
        const results = data.combined_results || [];
        
        resultsContainer.innerHTML = `
          <div class="space-y-4">
            <div class="flex flex-wrap gap-2">
              <span class="inline-block px-2 py-1 text-xs rounded bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300">
                Embedding: ${stats.embedding_hits || 0}
              </span>
              <span class="inline-block px-2 py-1 text-xs rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">
                Graph: ${stats.graph_hits || 0}
              </span>
              <span class="inline-block px-2 py-1 text-xs rounded bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                Total Unique: ${stats.unique_results || 0}
              </span>
            </div>
            
            ${results.length > 0 ? `
              <div class="space-y-2 max-h-96 overflow-y-auto">
                ${results.map((r, i) => {
                  const source = r.source || 'unknown';
                  const sourceClass = source === 'embedding' 
                    ? 'border-purple-200 dark:border-purple-800 bg-purple-50 dark:bg-purple-900/20' 
                    : 'border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20';
                  const sourceLabel = source === 'embedding' ? 'üß† Embedding' : 'üï∏Ô∏è Graph';
                  const score = r.combined_score || r.score || 0;
                  
                  return `
                    <div class="p-3 rounded-lg border ${sourceClass}">
                      <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-semibold">${sourceLabel}</span>
                        <span class="text-xs text-slate-500">Score: ${score.toFixed(3)}</span>
                      </div>
                      ${r.entity ? `<div class="text-sm font-medium text-slate-900 dark:text-white mb-1">${r.entity}</div>` : ''}
                      ${r.url ? `<div class="text-xs text-brand-600 dark:text-brand-400 truncate mb-1">${r.url}</div>` : ''}
                      ${r.text ? `<p class="text-xs text-slate-600 dark:text-slate-400 line-clamp-3">${r.text.substring(0, 300)}${r.text.length > 300 ? '...' : ''}</p>` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            ` : '<div class="text-sm text-slate-500 p-4">No results found</div>'}
          </div>
        `;
      } catch (err) {
        resultsContainer.innerHTML = `<div class="text-sm text-red-500 p-4">Error: ${err.message}</div>`;
      }
    });
  }
  
  // Autonomous Mode - Action Selection
  let selectedAction = 'reflect-relate';
  const actionButtons = document.querySelectorAll('.autonomous-action-btn');
  const selectedActionLabel = document.getElementById('selected-action-label');
  const runBtn = document.getElementById('autonomous-run-btn');
  const reflectRelateOptions = document.getElementById('reflect-relate-options');
  const discoverOptions = document.getElementById('discover-options');
  
  actionButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const action = btn.dataset.action;
      const color = btn.dataset.color;
      selectedAction = action;
      
      // Update button states
      actionButtons.forEach(b => {
        b.classList.remove('border-indigo-500', 'border-blue-500', 'border-purple-500', 'border-slate-500');
        b.classList.add('border-transparent');
      });
      btn.classList.remove('border-transparent');
      const colorMap = {
        'indigo': 'border-indigo-500',
        'blue': 'border-blue-500',
        'purple': 'border-purple-500',
        'slate': 'border-slate-500'
      };
      btn.classList.add(colorMap[color] || 'border-indigo-500');
      
      // Update label and button
      const labels = {
        'reflect-relate': 'üîç Run Reflect & Relate',
        'investigate-crawl': 'üï∏Ô∏è Run Investigate Crawl',
        'combined': 'üîÑ Run Combined Mode',
        'discover': 'ü§ñ Run Classic Discovery'
      };
      const labelTexts = {
        'reflect-relate': 'Reflect & Relate',
        'investigate-crawl': 'Investigate Crawl',
        'combined': 'Combined Mode',
        'discover': 'Classic Discovery'
      };
      
      if (selectedActionLabel) selectedActionLabel.textContent = labelTexts[action] || action;
      if (runBtn) runBtn.innerHTML = labels[action] || '‚ñ∂Ô∏è Run';
      
      // Show/hide action-specific options
      if (action === 'reflect-relate' || action === 'combined') {
        reflectRelateOptions.classList.remove('hidden');
      } else {
        reflectRelateOptions.classList.add('hidden');
      }
      
      if (action === 'discover') {
        discoverOptions.classList.remove('hidden');
      } else {
        discoverOptions.classList.add('hidden');
      }
    });
  });
  
  // Autonomous Form
  const autonomousForm = document.getElementById('agent-autonomous-form');
  autonomousForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const maxEntities = parseInt(document.getElementById('autonomous-max-entities').value) || 10;
    const priorityThreshold = parseFloat(document.getElementById('autonomous-priority-threshold').value) || 0.3;
    const maxDepth = parseInt(document.getElementById('autonomous-max-depth').value) || 3;
    const maxPages = parseInt(document.getElementById('autonomous-max-pages').value) || 25;
    const targetEntitiesInput = document.getElementById('autonomous-target-entities').value.trim();
    const targetEntities = targetEntitiesInput ? targetEntitiesInput.split(',').map(e => e.trim()).filter(e => e) : null;
    const topN = parseInt(document.getElementById('autonomous-top-n').value) || 20;
    const autoCrawl = document.getElementById('autonomous-auto-crawl').checked;
    
    const resultsContainer = document.getElementById('autonomous-results');
    const processMonitor = document.getElementById('process-monitor');
    
    resultsContainer.innerHTML = '<div class="text-sm text-indigo-600 p-4">‚öôÔ∏è Running autonomous mode...</div>';
    processMonitor.classList.remove('hidden');
    
    let endpoint = '/api/agent/autonomous';
    let body = {};
    
    if (selectedAction === 'reflect-relate') {
      endpoint = '/api/agent/autonomous/reflect-relate';
      body = { target_entities: targetEntities, max_depth: maxDepth, top_n: topN };
    } else if (selectedAction === 'investigate-crawl') {
      endpoint = '/api/agent/autonomous/investigate-crawl';
      body = { max_entities: maxEntities, max_pages: maxPages, max_depth: maxDepth, priority_threshold: priorityThreshold };
    } else if (selectedAction === 'combined') {
      endpoint = '/api/agent/autonomous/combined';
      body = { target_entities: targetEntities, max_entities: maxEntities, max_pages: maxPages, max_depth: maxDepth, priority_threshold: priorityThreshold };
    } else {
      body = { max_entities: maxEntities, priority_threshold: priorityThreshold, max_depth: maxDepth, auto_crawl: autoCrawl, max_pages: maxPages };
    }
    
    // Always use task queue for autonomous operations
    processMonitor.classList.remove('hidden');
    
    await runQueuedOperation(endpoint, body, resultsContainer, (data) => {
      // Start polling for process status if process_id is present
      if (data.process_id) {
        startProcessPolling();
      }
      renderAutonomousResults(data, selectedAction);
    });
  });
  
  // Process monitoring
  let processPollingInterval = null;
  
  async function loadProcesses() {
    try {
      const headers = { 'Content-Type': 'application/json' };
      const apiKey = getApiKey();
      if (apiKey) headers['X-API-Key'] = apiKey;
      
      const response = await fetch('/api/agent/autonomous/processes', {
        method: 'GET',
        headers: headers
      });
      
      const data = await response.json();
      const processes = data.processes || [];
      
      const processList = document.getElementById('process-list');
      if (!processList) return;
      
      if (processes.length === 0) {
        processList.innerHTML = '<div class="text-xs text-slate-500">No active processes</div>';
        return;
      }
      
      processList.innerHTML = processes.map(proc => {
        const statusBadges = {
          'running': 'üü¢ Running',
          'stopping': 'üü° Stopping',
          'completed': '‚úÖ Completed',
          'failed': '‚ùå Failed',
          'stopped': '‚èπÔ∏è Stopped'
        };
        const statusBadge = statusBadges[proc.status] || proc.status;
        
        return `
          <div class="p-2 rounded bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-xs">
            <div class="flex justify-between items-start mb-1">
              <span class="font-medium text-slate-800 dark:text-slate-200">${proc.action || 'Unknown'}</span>
              <span class="text-xs">${statusBadge}</span>
            </div>
            <div class="text-slate-600 dark:text-slate-400 text-xs">
              ID: ${proc.process_id || 'N/A'}
            </div>
            ${proc.current_task ? `<div class="text-slate-600 dark:text-slate-400 text-xs">Current: ${proc.current_task}</div>` : ''}
            ${proc.tasks_completed !== undefined && proc.tasks_total !== undefined ? `
              <div class="text-slate-600 dark:text-slate-400 text-xs">Progress: ${proc.tasks_completed}/${proc.tasks_total}</div>
            ` : ''}
            ${proc.status === 'running' ? `
              <button class="mt-2 px-2 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-500" onclick="stopProcess('${proc.process_id}')">Stop</button>
            ` : ''}
          </div>
        `;
      }).join('');
    } catch (err) {
      console.error('Failed to load processes:', err);
    }
  }
  
  function startProcessPolling() {
    if (processPollingInterval) return;
    loadProcesses();
    processPollingInterval = setInterval(loadProcesses, 5000);
  }
  
  function stopProcessPolling() {
    if (processPollingInterval) {
      clearInterval(processPollingInterval);
      processPollingInterval = null;
    }
  }
  
  // Make stopProcess available globally
  window.stopProcess = async (processId) => {
    try {
      const headers = { 'Content-Type': 'application/json' };
      const apiKey = getApiKey();
      if (apiKey) headers['X-API-Key'] = apiKey;
      
      const response = await fetch('/api/agent/autonomous/stop', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ process_id: processId })
      });
      
      const data = await response.json();
      if (data.success) {
        loadProcesses();
      } else {
        alert('Failed to stop process: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Error stopping process: ' + err.message);
    }
  };
  
  const refreshProcessesBtn = document.getElementById('refresh-processes-btn');
  if (refreshProcessesBtn) {
    refreshProcessesBtn.addEventListener('click', loadProcesses);
  }
  
  // Shared rendering function for autonomous results
  function renderAutonomousResults(data, action = 'discover') {
    const resultsContainer = document.getElementById('autonomous-results');
    if (!resultsContainer) return;
    
    if (data.error) {
      resultsContainer.innerHTML = `<div class="text-sm text-red-500 p-4">Error: ${data.error}</div>`;
      return;
    }
    
    const stats = data.statistics || {};
    
    if (action === 'reflect-relate') {
      renderReflectRelateResults(data, resultsContainer, stats);
    } else if (action === 'investigate-crawl') {
      renderInvestigateCrawlResults(data, resultsContainer, stats);
    } else if (action === 'combined') {
      renderCombinedResults(data, resultsContainer, stats);
    } else {
      renderDiscoverResults(data, resultsContainer, stats);
    }
  }
  
  function renderReflectRelateResults(data, container, stats) {
    const potentialRelations = data.potential_relations || [];
    const investigationTasks = data.investigation_tasks || [];
    
    container.innerHTML = `
      <div class="space-y-4">
        <!-- Statistics -->
        <div class="grid grid-cols-3 gap-3">
          <div class="p-3 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 text-center">
            <div class="text-2xl font-bold text-indigo-700 dark:text-indigo-300">${stats.entities_analyzed || 0}</div>
            <div class="text-xs text-indigo-600 dark:text-indigo-400">Entities Analyzed</div>
          </div>
          <div class="p-3 rounded-lg bg-purple-50 dark:bg-purple-900/20 text-center">
            <div class="text-2xl font-bold text-purple-700 dark:text-purple-300">${stats.potential_relations_found || 0}</div>
            <div class="text-xs text-purple-600 dark:text-purple-400">Potential Relations</div>
          </div>
          <div class="p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-center">
            <div class="text-2xl font-bold text-blue-700 dark:text-blue-300">${stats.investigation_tasks_created || 0}</div>
            <div class="text-xs text-blue-600 dark:text-blue-400">Investigation Tasks</div>
          </div>
        </div>
        
        <!-- Potential Relations -->
        ${potentialRelations.length > 0 ? `
          <div>
            <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">üîó Potential Relations</h5>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              ${potentialRelations.map(pr => `
                <div class="p-3 rounded border border-purple-200 dark:border-purple-800 bg-purple-50 dark:bg-purple-900/10 text-xs">
                  <div class="flex justify-between items-start mb-2">
                    <div class="font-medium text-purple-800 dark:text-purple-200">${pr.entity_a || 'Unknown'} ‚Üî ${pr.entity_b || 'Unknown'}</div>
                    <span class="px-2 py-0.5 rounded bg-purple-100 dark:bg-purple-800 text-purple-700 dark:text-purple-200">Confidence: ${(pr.confidence || 0).toFixed(2)}</span>
                  </div>
                  <div class="text-purple-600 dark:text-purple-400">${pr.reason || 'N/A'}</div>
                  ${pr.shared_neighbors ? `<div class="text-slate-600 dark:text-slate-400 mt-1">Shared neighbors: ${pr.shared_neighbors}</div>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        ` : '<div class="text-sm text-slate-500 p-4">No potential relations found</div>'}
        
        <!-- Investigation Tasks -->
        ${investigationTasks.length > 0 ? `
          <div>
            <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">üìã Investigation Tasks</h5>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              ${investigationTasks.map(task => `
                <div class="p-3 rounded border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/10 text-xs">
                  <div class="flex justify-between items-start mb-2">
                    <div class="font-medium text-blue-800 dark:text-blue-200">[${task.task_type || 'N/A'}] ${task.entity_name || 'Unknown'}</div>
                    <span class="px-2 py-0.5 rounded bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-200">Priority: ${(task.priority || 0).toFixed(2)}</span>
                  </div>
                  ${task.related_to ? `<div class="text-blue-600 dark:text-blue-400">Related to: ${task.related_to}</div>` : ''}
                  <div class="text-slate-600 dark:text-slate-400 mt-1">${task.reason || 'N/A'}</div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      </div>
    `;
  }
  
  function renderInvestigateCrawlResults(data, container, stats) {
    const crawlPlans = data.crawl_plans || [];
    const crawlResults = data.crawl_results || [];
    
    container.innerHTML = `
      <div class="space-y-4">
        <!-- Statistics -->
        <div class="grid grid-cols-5 gap-3">
          <div class="p-3 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 text-center">
            <div class="text-2xl font-bold text-indigo-700 dark:text-indigo-300">${stats.tasks_received || 0}</div>
            <div class="text-xs text-indigo-600 dark:text-indigo-400">Tasks Received</div>
          </div>
          <div class="p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-center">
            <div class="text-2xl font-bold text-blue-700 dark:text-blue-300">${stats.tasks_processed || 0}</div>
            <div class="text-xs text-blue-600 dark:text-blue-400">Processed</div>
          </div>
          <div class="p-3 rounded-lg bg-purple-50 dark:bg-purple-900/20 text-center">
            <div class="text-2xl font-bold text-purple-700 dark:text-purple-300">${stats.crawl_plans_generated || 0}</div>
            <div class="text-xs text-purple-600 dark:text-purple-400">Plans Generated</div>
          </div>
          <div class="p-3 rounded-lg bg-green-50 dark:bg-green-900/20 text-center">
            <div class="text-2xl font-bold text-green-700 dark:text-green-300">${stats.crawls_executed || 0}</div>
            <div class="text-xs text-green-600 dark:text-green-400">Crawls Executed</div>
          </div>
          <div class="p-3 rounded-lg bg-teal-50 dark:bg-teal-900/20 text-center">
            <div class="text-2xl font-bold text-teal-700 dark:text-teal-300">${stats.pages_discovered || 0}</div>
            <div class="text-xs text-teal-600 dark:text-teal-400">Pages Discovered</div>
          </div>
        </div>
        
        ${renderCrawlPlansSection(crawlPlans)}
        ${renderCrawlResultsSection(crawlResults)}
      </div>
    `;
  }
  
  function renderCombinedResults(data, container, stats) {
    const reflectReport = data.reflect_relate_report || {};
    const investigateReport = data.investigate_crawl_report || {};
    
    container.innerHTML = `
      <div class="space-y-4">
        <!-- Overall Statistics -->
        <div class="grid grid-cols-3 gap-3">
          <div class="p-3 rounded-lg bg-purple-50 dark:bg-purple-900/20 text-center">
            <div class="text-2xl font-bold text-purple-700 dark:text-purple-300">${stats.total_entities_analyzed || 0}</div>
            <div class="text-xs text-purple-600 dark:text-purple-400">Total Entities Analyzed</div>
          </div>
          <div class="p-3 rounded-lg bg-green-50 dark:bg-green-900/20 text-center">
            <div class="text-2xl font-bold text-green-700 dark:text-green-300">${stats.total_crawls_executed || 0}</div>
            <div class="text-xs text-green-600 dark:text-green-400">Total Crawls Executed</div>
          </div>
          <div class="p-3 rounded-lg bg-teal-50 dark:bg-teal-900/20 text-center">
            <div class="text-2xl font-bold text-teal-700 dark:text-teal-300">${stats.total_pages_discovered || 0}</div>
            <div class="text-xs text-teal-600 dark:text-teal-400">Total Pages Discovered</div>
          </div>
        </div>
        
        <!-- Phase 1: Reflect & Relate -->
        <div class="p-4 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800">
          <h5 class="text-sm font-bold text-indigo-700 dark:text-indigo-300 mb-2">Phase 1: Reflect & Relate</h5>
          <div class="text-xs text-indigo-600 dark:text-indigo-400 space-y-1">
            <div>Entities analyzed: ${(reflectReport.statistics || {}).entities_analyzed || 0}</div>
            <div>Potential relations: ${(reflectReport.statistics || {}).potential_relations_found || 0}</div>
            <div>Investigation tasks: ${(reflectReport.statistics || {}).investigation_tasks_created || 0}</div>
          </div>
        </div>
        
        <!-- Phase 2: Investigate Crawl -->
        <div class="p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
          <h5 class="text-sm font-bold text-blue-700 dark:text-blue-300 mb-2">Phase 2: Investigate Crawl</h5>
          <div class="text-xs text-blue-600 dark:text-blue-400 space-y-1">
            <div>Tasks processed: ${(investigateReport.statistics || {}).tasks_processed || 0}</div>
            <div>Crawls executed: ${(investigateReport.statistics || {}).crawls_executed || 0}</div>
            <div>Pages discovered: ${(investigateReport.statistics || {}).pages_discovered || 0}</div>
          </div>
        </div>
        
        ${renderCrawlResultsSection(investigateReport.crawl_results || [])}
      </div>
    `;
  }
  
  function renderDiscoverResults(data, container, stats) {
    const deadEnds = data.dead_ends || [];
    const gaps = data.knowledge_gaps || [];
    const plans = data.crawl_plans || [];
    const crawlResults = data.crawl_results || [];
    
    container.innerHTML = `
      <div class="space-y-4">
        <!-- Statistics -->
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
          <div class="p-3 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 text-center">
            <div class="text-2xl font-bold text-indigo-700 dark:text-indigo-300">${stats.entities_analyzed || 0}</div>
            <div class="text-xs text-indigo-600 dark:text-indigo-400">Analyzed</div>
          </div>
          <div class="p-3 rounded-lg bg-red-50 dark:bg-red-900/20 text-center">
            <div class="text-2xl font-bold text-red-700 dark:text-red-300">${stats.dead_ends_found || 0}</div>
            <div class="text-xs text-red-600 dark:text-red-400">Dead Ends</div>
          </div>
          <div class="p-3 rounded-lg bg-amber-50 dark:bg-amber-900/20 text-center">
            <div class="text-2xl font-bold text-amber-700 dark:text-amber-300">${stats.gaps_found || 0}</div>
            <div class="text-xs text-amber-600 dark:text-amber-400">Gaps Found</div>
          </div>
          <div class="p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-center">
            <div class="text-2xl font-bold text-blue-700 dark:text-blue-300">${stats.crawl_plans_generated || 0}</div>
            <div class="text-xs text-blue-600 dark:text-blue-400">Crawl Plans</div>
          </div>
          <div class="p-3 rounded-lg bg-green-50 dark:bg-green-900/20 text-center">
            <div class="text-2xl font-bold text-green-700 dark:text-green-300">${stats.crawls_executed || 0}</div>
            <div class="text-xs text-green-600 dark:text-green-400">Crawls Run</div>
          </div>
        </div>
        
        ${data.message ? '<div class="text-sm text-slate-500 p-2">' + data.message + '</div>' : ''}
        
        <!-- Dead Ends -->
        ${deadEnds.length > 0 ? `
          <div>
            <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">üî¥ Dead-End Entities</h5>
            <div class="overflow-x-auto">
              <table class="w-full text-xs">
                <thead class="bg-slate-100 dark:bg-slate-800">
                  <tr>
                    <th class="px-2 py-1 text-left">Entity</th>
                    <th class="px-2 py-1 text-left">Kind</th>
                    <th class="px-2 py-1 text-center">Outgoing</th>
                    <th class="px-2 py-1 text-center">Incoming</th>
                    <th class="px-2 py-1 text-center">Dead End</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                  ${deadEnds.slice(0, 15).map((de, i) => `
                    <tr class="${i % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-slate-50 dark:bg-slate-800/50'}">
                      <td class="px-2 py-1 font-medium text-slate-900 dark:text-white">${de.name || 'Unknown'}</td>
                      <td class="px-2 py-1 text-slate-600 dark:text-slate-400">${de.kind || '-'}</td>
                      <td class="px-2 py-1 text-center">${de.outgoing_relations || 0}</td>
                      <td class="px-2 py-1 text-center">${de.incoming_relations || 0}</td>
                      <td class="px-2 py-1 text-center">${de.is_dead_end ? '<span class="text-red-600 font-bold">Yes</span>' : 'No'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        ` : ''}
        
        <!-- Knowledge Gaps -->
        ${gaps.length > 0 ? `
          <div>
            <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">‚ö†Ô∏è Knowledge Gaps</h5>
            <div class="space-y-2 max-h-60 overflow-y-auto">
              ${gaps.slice(0, 10).map(gap => `
                <div class="p-2 rounded border border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/10 text-xs">
                  <div class="flex justify-between items-start">
                    <div class="font-medium text-amber-800 dark:text-amber-200">${gap.entity_name || 'Unknown'}</div>
                    <span class="px-2 py-0.5 rounded bg-amber-100 dark:bg-amber-800 text-amber-700 dark:text-amber-200 text-xs">Gap Score: ${gap.gap_score || 0}</span>
                  </div>
                  <div class="text-amber-600 dark:text-amber-400 mt-1">
                    Intel: ${gap.intelligence_count || 0} | Missing: ${(gap.missing_fields || []).join(', ') || 'none'}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${renderCrawlPlansSection(plans)}
        ${renderCrawlResultsSection(crawlResults)}
      </div>
    `;
  }
  
  function renderCrawlPlansSection(plans) {
    if (plans.length === 0) return '';
    return `
      <div>
        <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">üìã Generated Crawl Plans</h5>
        <div class="space-y-2 max-h-60 overflow-y-auto">
          ${plans.map(plan => `
            <div class="p-2 rounded border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/10 text-xs">
              <div class="flex justify-between items-start">
                <div class="font-medium text-blue-800 dark:text-blue-200">${plan.entity_name || 'Unknown'}</div>
                <span class="px-2 py-0.5 rounded bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-200 text-xs">Priority: ${(plan.priority_score || 0).toFixed(3)}</span>
              </div>
              <div class="text-blue-600 dark:text-blue-400 mt-1">
                Mode: ${plan.mode || '-'} | Strategy: ${plan.strategy || '-'}
              </div>
              ${(plan.queries && plan.queries.length > 0) ? `
                <div class="mt-1 text-slate-600 dark:text-slate-400">
                  Queries: ${plan.queries.slice(0, 3).join(', ')}${plan.queries.length > 3 ? ' +' + (plan.queries.length - 3) + ' more' : ''}
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  function renderCrawlResultsSection(crawlResults) {
    if (crawlResults.length === 0) return '';
    return `
      <div>
        <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">‚úÖ Crawl Results</h5>
        <div class="space-y-2 max-h-60 overflow-y-auto">
          ${crawlResults.map(cr => `
            <div class="p-2 rounded border ${cr.error ? 'border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/10' : 'border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/10'} text-xs">
              <div class="font-medium ${cr.error ? 'text-red-800 dark:text-red-200' : 'text-green-800 dark:text-green-200'}">${cr.entity_name || 'Unknown'}</div>
              ${cr.error 
                ? '<div class="text-red-600 dark:text-red-400 mt-1">Error: ' + cr.error + '</div>'
                : '<div class="text-green-600 dark:text-green-400 mt-1">Mode: ' + (cr.plan_mode || '-') + ' | Pages: ' + ((cr.result || {}).pages_discovered || 0) + ' | Intel: ' + ((cr.result || {}).intel_extracted || 0) + '</div>'
              }
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  // =========================================================================
  // AUTOMATIC MODE - Continuous Combined Mode Loop
  // =========================================================================
  let autoModeRunning = false;
  let autoModeCycleCount = 0;
  
  const autoModeToggle = document.getElementById('auto-mode-toggle');
  const autoModeStatus = document.getElementById('auto-mode-status');
  const autoModeLog = document.getElementById('auto-mode-log');
  
  function addAutoModeLogEntry(message, type = 'info') {
    if (!autoModeLog) return;
    autoModeLog.classList.remove('hidden');
    const colors = {
      info: 'text-indigo-700 dark:text-indigo-300',
      success: 'text-green-700 dark:text-green-300',
      error: 'text-red-700 dark:text-red-300',
      warn: 'text-amber-700 dark:text-amber-300',
    };
    const entry = document.createElement('div');
    entry.className = `text-xs ${colors[type] || colors.info} py-1 border-b border-slate-100 dark:border-slate-800`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    autoModeLog.prepend(entry);
    // Keep last 50 entries
    while (autoModeLog.children.length > 50) {
      autoModeLog.removeChild(autoModeLog.lastChild);
    }
  }
  
  async function runAutoModeCycle() {
    if (!autoModeRunning) return;
    
    autoModeCycleCount++;
    addAutoModeLogEntry(`Cycle #${autoModeCycleCount} starting...`, 'info');
    
    const maxEntities = parseInt(document.getElementById('autonomous-max-entities').value) || 10;
    const priorityThreshold = parseFloat(document.getElementById('autonomous-priority-threshold').value) || 0.3;
    const maxDepth = parseInt(document.getElementById('autonomous-max-depth').value) || 3;
    const maxPages = parseInt(document.getElementById('autonomous-max-pages').value) || 25;
    const targetEntitiesInput = document.getElementById('autonomous-target-entities').value.trim();
    const targetEntities = targetEntitiesInput ? targetEntitiesInput.split(',').map(e => e.trim()).filter(e => e) : null;
    
    try {
      const headers = { 'Content-Type': 'application/json' };
      const apiKey = getApiKey();
      if (apiKey) headers['X-API-Key'] = apiKey;
      
      const response = await fetch('/api/agent/autonomous/combined', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
          target_entities: targetEntities,
          max_entities: maxEntities,
          max_pages: maxPages,
          max_depth: maxDepth,
          priority_threshold: priorityThreshold,
          queued: true
        })
      });
      
      const data = await response.json();
      
      if (data.task_id) {
        addAutoModeLogEntry(`Cycle #${autoModeCycleCount} queued (task: ${data.task_id.substring(0, 8)}...)`, 'info');
        
        // Poll task until completion
        try {
          const result = await pollTaskResult(data.task_id, {});
          const stats = result.statistics || {};
          addAutoModeLogEntry(
            `Cycle #${autoModeCycleCount} completed: ${stats.total_entities_analyzed || 0} entities, ${stats.total_crawls_executed || 0} crawls, ${stats.total_pages_discovered || 0} pages`,
            'success'
          );
          
          // Update results panel
          const resultsContainer = document.getElementById('autonomous-results');
          if (resultsContainer) {
            renderCombinedResults(result, resultsContainer, stats);
          }
        } catch (pollErr) {
          addAutoModeLogEntry(`Cycle #${autoModeCycleCount} task failed: ${pollErr.message}`, 'error');
        }
      } else if (data.error) {
        addAutoModeLogEntry(`Cycle #${autoModeCycleCount} error: ${data.error}`, 'error');
      }
    } catch (err) {
      addAutoModeLogEntry(`Cycle #${autoModeCycleCount} failed: ${err.message}`, 'error');
    }
    
    // Continue loop if still running (with a brief pause)
    if (autoModeRunning) {
      addAutoModeLogEntry(`Waiting 5 seconds before next cycle...`, 'info');
      setTimeout(runAutoModeCycle, 5000);
    }
  }
  
  if (autoModeToggle) {
    autoModeToggle.addEventListener('change', () => {
      if (autoModeToggle.checked) {
        autoModeRunning = true;
        autoModeCycleCount = 0;
        if (autoModeStatus) {
          autoModeStatus.textContent = 'Running';
          autoModeStatus.classList.remove('text-slate-500');
          autoModeStatus.classList.add('text-green-600', 'dark:text-green-400');
        }
        addAutoModeLogEntry('Automatic mode started', 'success');
        const processMonitor = document.getElementById('process-monitor');
        if (processMonitor) processMonitor.classList.remove('hidden');
        startProcessPolling();
        runAutoModeCycle();
      } else {
        autoModeRunning = false;
        if (autoModeStatus) {
          autoModeStatus.textContent = 'Stopped';
          autoModeStatus.classList.remove('text-green-600', 'dark:text-green-400');
          autoModeStatus.classList.add('text-slate-500');
        }
        addAutoModeLogEntry('Automatic mode stopped by user', 'warn');
      }
    });
  }

  // Load agent status on page load
  async function loadAgentStatus() {
    try {
      const headers = {};
      const apiKey = getApiKey();
      if (apiKey) headers['X-API-Key'] = apiKey;
      
      const response = await fetch('/api/agent/status', { headers });
      const data = await response.json();
      
      const badge = document.getElementById('agent-status-badge');
      if (data.enabled !== false) {
        badge.textContent = 'Agent Active';
        badge.classList.remove('bg-red-100', 'text-red-700');
        badge.classList.add('bg-green-100', 'text-green-700');
      } else {
        badge.textContent = 'Agent Disabled';
        badge.classList.remove('bg-green-100', 'text-green-700');
        badge.classList.add('bg-red-100', 'text-red-700');
      }
      
      // Populate autonomous mode defaults from server config
      const auto = data.autonomous || {};
      if (auto.max_entities !== undefined) {
        document.getElementById('autonomous-max-entities').value = auto.max_entities;
      }
      if (auto.priority_threshold !== undefined) {
        document.getElementById('autonomous-priority-threshold').value = auto.priority_threshold;
      }
      if (auto.max_depth !== undefined) {
        document.getElementById('autonomous-max-depth').value = auto.max_depth;
      }
      if (auto.auto_crawl !== undefined) {
        document.getElementById('autonomous-auto-crawl').checked = auto.auto_crawl;
      }
      if (auto.max_pages !== undefined) {
        document.getElementById('autonomous-max-pages').value = auto.max_pages;
      }
    } catch (err) {
      console.warn('Could not load agent status:', err);
    }
  }
  
  loadAgentStatus();

  // =========================================================================
  // TASK QUEUE PANEL
  // =========================================================================
  const statusColors = {
    pending: 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300',
    running: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
    completed: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
    failed: 'bg-rose-100 text-rose-800 dark:bg-rose-900/30 dark:text-rose-300',
    cancelled: 'bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-300',
  };

  async function tqFetch(path, opts = {}) {
    const headers = { ...(opts.headers || {}) };
    const key = getApiKey();
    if (key) headers['X-API-Key'] = key;
    const res = await fetch(path, { ...opts, headers });
    return res.json();
  }

  async function loadQueueStats() {
    try {
      const stats = await tqFetch('/api/tasks/stats');
      const counts = stats.counts || {};
      document.getElementById('tq-stat-pending').textContent = counts.pending ?? '-';
      document.getElementById('tq-stat-running').textContent = counts.running ?? '-';
      document.getElementById('tq-stat-completed').textContent = counts.completed ?? '-';
      document.getElementById('tq-stat-failed').textContent = counts.failed ?? '-';
      document.getElementById('tq-stat-cancelled').textContent = counts.cancelled ?? '-';
    } catch (e) {
      console.warn('Failed to load queue stats:', e);
    }
  }

  async function loadTaskList() {
    try {
      const filterStatus = document.getElementById('tq-filter-status').value;
      const url = filterStatus ? `/api/tasks/?status=${filterStatus}&limit=50` : '/api/tasks/?limit=50';
      const data = await tqFetch(url);
      const tasks = data.tasks || [];
      const listEl = document.getElementById('tq-task-list');

      if (tasks.length === 0) {
        listEl.innerHTML = '<div class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">No tasks found</div>';
        return;
      }

      listEl.innerHTML = tasks.map(t => {
        const statusClass = statusColors[t.status] || statusColors.pending;
        const progressBar = t.status === 'running' && t.progress != null
          ? `<div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-1.5 mt-1">
               <div class="bg-blue-500 h-1.5 rounded-full" style="width:${Math.round((t.progress || 0) * 100)}%"></div>
             </div>`
          : '';
        const errorInfo = t.error
          ? `<div class="text-xs text-rose-600 dark:text-rose-400 mt-1 truncate" title="${t.error}">‚ö†Ô∏è ${t.error}</div>`
          : '';
        const created = t.created_at ? new Date(t.created_at).toLocaleString() : '';
        const actions = [];
        if (t.status === 'pending' || t.status === 'running') {
          actions.push(`<button class="tq-cancel-btn text-xs px-2 py-0.5 rounded bg-rose-600 text-white hover:bg-rose-500" data-task-id="${t.id}">Cancel</button>`);
        }
        if (t.status === 'completed' || t.status === 'failed' || t.status === 'cancelled') {
          actions.push(`<button class="tq-delete-btn text-xs px-2 py-0.5 rounded bg-slate-600 text-white hover:bg-slate-500" data-task-id="${t.id}">Delete</button>`);
        }
        if (t.status === 'completed' && t.result) {
          actions.push(`<button class="tq-view-btn text-xs px-2 py-0.5 rounded bg-green-600 text-white hover:bg-green-500" data-task-id="${t.id}">View Result</button>`);
        }

        return `
          <div class="p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/50">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 text-xs font-bold rounded-full ${statusClass}">${t.status}</span>
                <span class="text-sm font-medium text-slate-800 dark:text-slate-200">${t.task_type}</span>
              </div>
              <div class="flex items-center gap-2">
                ${actions.join(' ')}
              </div>
            </div>
            ${t.progress_message ? `<div class="text-xs text-slate-600 dark:text-slate-400 mt-1">${t.progress_message}</div>` : ''}
            ${progressBar}
            ${errorInfo}
            <div class="text-xs text-slate-400 mt-1">${created} ¬∑ <span class="font-mono">${t.id.substring(0, 8)}‚Ä¶</span></div>
          </div>
        `;
      }).join('');

      // Bind cancel buttons
      listEl.querySelectorAll('.tq-cancel-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          await tqFetch(`/api/tasks/${btn.dataset.taskId}/cancel`, { method: 'POST' });
          refreshTaskQueue();
        });
      });

      // Bind delete buttons
      listEl.querySelectorAll('.tq-delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          await tqFetch(`/api/tasks/${btn.dataset.taskId}`, { method: 'DELETE' });
          refreshTaskQueue();
        });
      });

      // Bind view result buttons
      listEl.querySelectorAll('.tq-view-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const task = await tqFetch(`/api/tasks/${btn.dataset.taskId}`);
          const formatted = JSON.stringify(task.result, null, 2);
          // Show result in a styled overlay
          const overlay = document.createElement('div');
          overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/50';
          overlay.innerHTML = `
            <div class="bg-white dark:bg-slate-900 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 max-w-2xl w-full max-h-[80vh] flex flex-col m-4">
              <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="font-bold text-slate-800 dark:text-slate-200">Task Result</h3>
                <button class="tq-close-overlay text-slate-400 hover:text-slate-600 text-xl">&times;</button>
              </div>
              <pre class="p-4 overflow-auto text-xs font-mono text-slate-800 dark:text-slate-200 flex-1">${formatted.replace(/</g, '&lt;')}</pre>
            </div>
          `;
          document.body.appendChild(overlay);
          overlay.querySelector('.tq-close-overlay').addEventListener('click', () => overlay.remove());
          overlay.addEventListener('click', (ev) => { if (ev.target === overlay) overlay.remove(); });
        });
      });
    } catch (e) {
      console.warn('Failed to load task list:', e);
    }
  }

  function refreshTaskQueue() {
    loadQueueStats();
    loadTaskList();
  }

  // Bind refresh button
  const tqRefreshBtn = document.getElementById('tq-refresh-btn');
  if (tqRefreshBtn) tqRefreshBtn.addEventListener('click', refreshTaskQueue);

  // Bind filter change
  const tqFilter = document.getElementById('tq-filter-status');
  if (tqFilter) tqFilter.addEventListener('change', loadTaskList);

  // Auto-refresh: 3 seconds when active tasks exist, 5 seconds otherwise
  let tqInterval = null;
  function startTqAutoRefresh() {
    if (tqInterval) return;
    tqInterval = setInterval(() => {
      const panel = document.getElementById('agent-panel-taskqueue');
      const autoCheck = document.getElementById('tq-auto-refresh');
      if (panel && !panel.classList.contains('hidden') && autoCheck && autoCheck.checked) {
        refreshTaskQueue();
      }
    }, 3000);
  }
  startTqAutoRefresh();

  // Initial load when task queue tab is shown
  const tqTab = document.getElementById('agent-tab-taskqueue');
  if (tqTab) {
    tqTab.addEventListener('click', refreshTaskQueue);
  }
  // Also load on page load if panel is visible
  refreshTaskQueue();
});
</script>
