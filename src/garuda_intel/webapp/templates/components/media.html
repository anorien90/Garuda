<div class="space-y-6">
  <!-- Media Processing Overview -->
  <div class="card p-6 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 border-2 border-purple-200 dark:border-purple-800">
    <h2 class="text-xl font-bold mb-2 text-purple-900 dark:text-purple-100">üé¨ Media Processing</h2>
    <p class="text-sm text-purple-700 dark:text-purple-300 mb-4">
      Extract text from images, videos, and audio files. Convert media into embeddings and integrate into the knowledge graph.
    </p>
    
    <div class="grid grid-cols-3 gap-4 mt-4">
      <div class="text-center p-3 bg-white/60 dark:bg-slate-900/40 rounded-lg border border-purple-200 dark:border-purple-800">
        <div class="text-2xl mb-1">üñºÔ∏è</div>
        <div class="text-xs font-semibold text-purple-900 dark:text-purple-100">Images (OCR)</div>
      </div>
      <div class="text-center p-3 bg-white/60 dark:bg-slate-900/40 rounded-lg border border-purple-200 dark:border-purple-800">
        <div class="text-2xl mb-1">üé•</div>
        <div class="text-xs font-semibold text-purple-900 dark:text-purple-100">Video (Speech)</div>
      </div>
      <div class="text-center p-3 bg-white/60 dark:bg-slate-900/40 rounded-lg border border-purple-200 dark:border-purple-800">
        <div class="text-2xl mb-1">üéµ</div>
        <div class="text-xs font-semibold text-purple-900 dark:text-purple-100">Audio (STT)</div>
      </div>
    </div>
  </div>
  
  <!-- Media Processing Settings -->
  <div class="card p-6">
    <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Media Processing Settings</h2>
    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
      Configure media crawling and processing options.
    </p>
    
    <div class="space-y-4">
      <div class="flex items-center justify-between p-3 border rounded-lg">
        <div>
          <h3 class="font-semibold">Enable Media Crawling</h3>
          <p class="text-sm text-slate-600 dark:text-slate-400">Automatically extract media from crawled pages</p>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="enable-media-crawling" class="sr-only peer" checked>
          <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-300 dark:peer-focus:ring-brand-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-brand-600"></div>
        </label>
      </div>
      
      <div class="flex items-center justify-between p-3 border rounded-lg">
        <div>
          <h3 class="font-semibold">Auto-Process Media</h3>
          <p class="text-sm text-slate-600 dark:text-slate-400">Automatically extract text from media items</p>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="enable-media-processing" class="sr-only peer" checked>
          <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-300 dark:peer-focus:ring-brand-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-brand-600"></div>
        </label>
      </div>
      
      <div class="flex items-center justify-between p-3 border rounded-lg">
        <div>
          <h3 class="font-semibold">Generate Embeddings</h3>
          <p class="text-sm text-slate-600 dark:text-slate-400">Create vector embeddings from extracted text</p>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="enable-media-embeddings" class="sr-only peer" checked>
          <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-300 dark:peer-focus:ring-brand-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-brand-600"></div>
        </label>
      </div>
    </div>
  </div>
  
  <!-- Browse Media Items -->
  <div class="card p-6">
    <h2 class="text-xl font-bold mb-4">üìÇ Browse Media Items</h2>
    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
      View and manage extracted media items from crawled pages.
    </p>
    
    <div class="mb-4 flex gap-2">
      <select id="media-type-filter" class="px-3 py-2 border rounded-lg text-sm">
        <option value="">All Media Types</option>
        <option value="image">Images</option>
        <option value="video">Videos</option>
        <option value="audio">Audio</option>
      </select>
      
      <select id="media-processed-filter" class="px-3 py-2 border rounded-lg text-sm">
        <option value="">All Status</option>
        <option value="processed">Processed</option>
        <option value="unprocessed">Unprocessed</option>
        <option value="error">Errors</option>
      </select>
      
      <button onclick="window.loadMediaItems()" class="btn-primary">
        Refresh
      </button>
      
      <button onclick="window.processPendingMedia()" class="btn-secondary">
        Process Pending (10)
      </button>
    </div>
    
    <div id="media-items-container" class="space-y-3">
      <p class="text-sm text-slate-500 italic">Click "Refresh" to load media items...</p>
    </div>
  </div>
  
  <!-- Process Media Manually -->
  <div class="card p-6">
    <h2 class="text-xl font-bold mb-4">üîÑ Process Media Manually</h2>
    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
      Manually trigger media processing for specific items or URLs.
    </p>
    
    <form id="manual-media-process-form" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Media URL</label>
        <input type="url" id="media-url" 
               class="w-full px-3 py-2 border rounded-lg"
               placeholder="https://example.com/image.jpg" required>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-1">Media Type</label>
        <select id="media-type" class="w-full px-3 py-2 border rounded-lg">
          <option value="image">Image</option>
          <option value="video">Video</option>
          <option value="audio">Audio</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-1">Associated Page URL (Optional)</label>
        <input type="url" id="media-page-url" 
               class="w-full px-3 py-2 border rounded-lg"
               placeholder="https://example.com/page">
      </div>
      
      <button type="submit" class="btn-primary">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
        </svg>
        Process Media
      </button>
    </form>
    
    <div id="media-process-result" class="mt-4"></div>
  </div>
  
  <!-- Media Statistics -->
  <div class="card p-6">
    <h2 class="text-xl font-bold mb-4">üìä Media Statistics</h2>
    <div id="media-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="p-4 border rounded-lg text-center">
        <div class="text-2xl font-bold text-brand-600" id="stat-total-media">-</div>
        <div class="text-xs text-slate-600 dark:text-slate-400">Total Media</div>
      </div>
      <div class="p-4 border rounded-lg text-center">
        <div class="text-2xl font-bold text-green-600" id="stat-processed-media">-</div>
        <div class="text-xs text-slate-600 dark:text-slate-400">Processed</div>
      </div>
      <div class="p-4 border rounded-lg text-center">
        <div class="text-2xl font-bold text-yellow-600" id="stat-pending-media">-</div>
        <div class="text-xs text-slate-600 dark:text-slate-400">Pending</div>
      </div>
      <div class="p-4 border rounded-lg text-center">
        <div class="text-2xl font-bold text-red-600" id="stat-error-media">-</div>
        <div class="text-xs text-slate-600 dark:text-slate-400">Errors</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
// Import shared API functions
import { fetchWithAPIKey } from '/static/api.js';

// Helper to handle API responses
async function fetchWithAuth(url, options = {}) {
  const response = await fetchWithAPIKey(url, options);
  return response.json();
}

async function loadMediaStats() {
  try {
    const stats = await fetchWithAuth('/api/media/stats');
    document.getElementById('stat-total-media').textContent = stats.total || 0;
    document.getElementById('stat-processed-media').textContent = stats.processed || 0;
    document.getElementById('stat-pending-media').textContent = stats.pending || 0;
    document.getElementById('stat-error-media').textContent = stats.errors || 0;
  } catch (error) {
    console.error('Error loading media stats:', error);
  }
}

async function loadMediaItems() {
  const container = document.getElementById('media-items-container');
  container.innerHTML = '<p class="text-sm text-slate-500 italic">Loading media items...</p>';
  
  try {
    const typeFilter = document.getElementById('media-type-filter').value;
    const statusFilter = document.getElementById('media-processed-filter').value;
    
    let params = new URLSearchParams({ limit: 50 });
    if (typeFilter) params.append('type', typeFilter);
    if (statusFilter === 'processed') params.append('processed', 'true');
    else if (statusFilter === 'unprocessed') params.append('processed', 'false');
    else if (statusFilter === 'error') params.append('processed', 'error');
    
    const data = await fetchWithAuth(`/api/media/items?${params}`);
    
    if (data.items && data.items.length > 0) {
      container.innerHTML = data.items.map(item => `
        <div class="p-3 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800">
          <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs px-2 py-0.5 rounded ${
                  item.media_type === 'image' ? 'bg-blue-100 text-blue-800' :
                  item.media_type === 'video' ? 'bg-purple-100 text-purple-800' :
                  'bg-green-100 text-green-800'
                }">${item.media_type}</span>
                ${item.processed ? 
                  '<span class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-800">‚úì Processed</span>' :
                  item.processing_error ?
                  '<span class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-800">‚úó Error</span>' :
                  '<span class="text-xs px-2 py-0.5 rounded bg-yellow-100 text-yellow-800">‚è≥ Pending</span>'
                }
              </div>
              <div class="text-sm font-mono text-slate-600 dark:text-slate-400 truncate">${item.url}</div>
              ${item.extracted_text ? `
                <div class="text-xs text-slate-500 mt-1 line-clamp-2">${item.extracted_text}</div>
              ` : ''}
              ${item.processing_error ? `
                <div class="text-xs text-red-600 mt-1">${item.processing_error}</div>
              ` : ''}
            </div>
          </div>
          <div class="text-xs text-slate-400 mt-2">
            Created: ${new Date(item.created_at).toLocaleString()}
            ${item.processed_at ? ` | Processed: ${new Date(item.processed_at).toLocaleString()}` : ''}
          </div>
        </div>
      `).join('');
    } else {
      container.innerHTML = '<p class="text-sm text-slate-500 italic">No media items found. Try processing a media URL below.</p>';
    }
    
    // Refresh stats
    loadMediaStats();
    
  } catch (error) {
    container.innerHTML = `<p class="text-sm text-red-500">Error: ${error.message}</p>`;
  }
}

async function processPendingMedia() {
  const container = document.getElementById('media-items-container');
  const oldContent = container.innerHTML;
  container.innerHTML = '<p class="text-sm text-blue-500">Processing pending media items...</p>';
  
  try {
    const result = await fetchWithAuth('/api/media/process-pending', {
      method: 'POST'
    });
    
    alert(`Processed ${result.processed} items, ${result.failed} failed`);
    
    // Refresh the list
    loadMediaItems();
    
  } catch (error) {
    container.innerHTML = oldContent;
    alert(`Error processing pending media: ${error.message}`);
  }
}

// Manual media processing form
document.getElementById('manual-media-process-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const resultDiv = document.getElementById('media-process-result');
  const submitBtn = e.target.querySelector('button[type="submit"]');
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing...';
  resultDiv.innerHTML = '<p class="text-sm text-slate-500 italic">Processing media...</p>';
  
  try {
    const url = document.getElementById('media-url').value;
    const media_type = document.getElementById('media-type').value;
    const page_url = document.getElementById('media-page-url').value || null;
    
    const result = await fetchWithAuth('/api/media/process', {
      method: 'POST',
      body: JSON.stringify({
        url,
        media_type,
        page_url,
        auto_process: true
      })
    });
    
    if (result.processed) {
      resultDiv.innerHTML = `<div class="p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-sm">
        <div class="font-semibold text-green-800 dark:text-green-200">‚úì Media processed successfully!</div>
        ${result.extracted_text ? `<div class="mt-2 text-xs text-green-700 dark:text-green-300">Extracted text: ${result.extracted_text}</div>` : ''}
        ${result.has_embedding ? '<div class="mt-1 text-xs text-green-700 dark:text-green-300">‚úì Embedding generated</div>' : ''}
      </div>`;
      
      // Refresh the media items list
      setTimeout(() => loadMediaItems(), 500);
    } else if (result.processing_error) {
      resultDiv.innerHTML = `<div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg text-sm">
        <div class="font-semibold text-yellow-800 dark:text-yellow-200">‚ö† Media item created but processing failed</div>
        <div class="mt-2 text-xs text-yellow-700 dark:text-yellow-300">Error: ${result.processing_error}</div>
      </div>`;
    } else {
      resultDiv.innerHTML = `<div class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg text-sm">
        <div class="font-semibold text-blue-800 dark:text-blue-200">Media item created</div>
        <div class="mt-2 text-xs text-blue-700 dark:text-blue-300">${result.message}</div>
      </div>`;
    }
    
    // Clear form
    e.target.reset();
    
  } catch (error) {
    resultDiv.innerHTML = `<div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-sm">
      <div class="font-semibold text-red-800 dark:text-red-200">‚úó Error</div>
      <div class="mt-2 text-xs text-red-700 dark:text-red-300">${error.message}</div>
    </div>`;
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>Process Media';
  }
});

// Expose functions to global scope for inline onclick handlers
window.loadMediaItems = loadMediaItems;
window.processPendingMedia = processPendingMedia;

// Load stats on page load
document.addEventListener('DOMContentLoaded', () => {
  loadMediaStats();
  // Auto-load media items after a short delay
  setTimeout(() => loadMediaItems(), 100);
});
</script>
